<!-- ns-3 doxygen header, based on
     HTML header for doxygen 1.8.3.1
     Verified compatible with 1.8.6
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta name="generator" content="Doxygen 1.8.13" />
  <title>MilliCar: model/mmwave-vehicular-spectrum-propagation-loss-model.cc Source File</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="ns3_stylesheet.css" rel="stylesheet" type="text/css"/>
  <link href="favicon.ico" rel="shortcut icon" type="image/ico">
  </link>
  <script type="text/javascript" src="drop-down-menu.js"></script>
  <script type="text/javascript" src="ns3_version.js"></script>
  <script type="text/javascript" src="ns3_links.js"></script>
</head>
<body>
  <div id="top">
    <!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
      <table cellspacing="0" cellpadding="0" width="100%">
        <tbody>
          <tr style="height: 56px;">
            <td id="projectlogo">
              <a id="ns3_home1" href="http://http://signet.dei.unipd.it//">
                <img alt="ns-3 Logo" src="logo_signet.png" />
              </a>
            </td>
            <td id="projecttext">
              <div id="projectbrief">MilliCar: An ns-3 Module for NR V2X Networks</div>
            </td>
            <td id="projectsection">
              <span style="margin-right:10px">API Documentation</span>
            </td>
          </tr>
        </tbody>
      </table>
      <script type="text/javascript">
        ns3_write_links();
      </script>
    </div>
    <!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">mmwave-vehicular-spectrum-propagation-loss-model.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">*   Copyright (c) 2015, NYU WIRELESS, Tandon School of Engineering, New York</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">*   University</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">*   Copyright (c) 2016, 2018, 2020 University of Padova, Dep. of Information</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">*   Engineering, SIGNET lab.</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">*   This program is free software; you can redistribute it and/or modify</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">*   it under the terms of the GNU General Public License version 2 as</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">*   published by the Free Software Foundation;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">*   This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">*   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">*   GNU General Public License for more details.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">*   You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">*   along with this program; if not, write to the Free Software</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">*   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html">mmwave-vehicular-spectrum-propagation-loss-model.h</a>&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;ns3/log.h&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;ns3/math.h&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;ns3/simulator.h&gt;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;ns3/node.h&gt;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;ns3/double.h&gt;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;random&gt;</span>       <span class="comment">// std::default_random_engine</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;ns3/boolean.h&gt;</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;ns3/integer.h&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacens3.html">ns3</a> {</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacemillicar.html">millicar</a> {</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;NS_LOG_COMPONENT_DEFINE (<span class="stringliteral">&quot;MmWaveVehicularSpectrumPropagationLossModel&quot;</span>);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;NS_OBJECT_ENSURE_REGISTERED (MmWaveVehicularSpectrumPropagationLossModel);</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">//Table 7.5-3: Ray offset angles within a cluster, given for rms angle spread normalized to 1.</span></div><div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="namespacens3_1_1millicar.html#a911c55f059ab4c00d336d42eb5e72d62">   43</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacens3_1_1millicar.html#a911c55f059ab4c00d336d42eb5e72d62">offSetAlpha</a>[20] = {</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  0.0447,-0.0447,0.1413,-0.1413,0.2492,-0.2492,0.3715,-0.3715,0.5129,-0.5129,0.6797,-0.6797,0.8844,-0.8844,1.1481,-1.1481,1.5195,-1.5195,2.1551,-2.1551</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;};</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"> * The cross correlation matrix is constructed according to table 7.5-6.</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"> * All the square root matrix is being generated using the Cholesky decomposition</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"> * and following the order of [SF,K,DS,ASD,ASA,ZSD,ZSA].</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"> * The parameter K is ignored in NLOS.</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> * The Matlab file to generate the matrices can be found in the mmwave/model/BeamFormingMatrix/SqrtMatrix.m</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"> * */</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="namespacens3_1_1millicar.html#af0398762891de0afcdd4c32592b3c5b9">   56</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacens3_1_1millicar.html#af0398762891de0afcdd4c32592b3c5b9">sqrtC_UMi_LOS</a>[7][7] = {</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  {1, 0, 0, 0, 0, 0, 0},</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  {0.5, 0.866025, 0, 0, 0, 0, 0},</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  {-0.4, -0.57735, 0.711805, 0, 0, 0, 0},</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  {-0.5, 0.057735, 0.468293, 0.726201, 0, 0, 0},</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  {-0.4, -0.11547, 0.805464, -0.23482, 0.350363, 0, 0},</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  {0, 0, 0, 0.688514, 0.461454, 0.559471, 0},</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  {0, 0, 0.280976, 0.231921, -0.490509, 0.11916, 0.782603},</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;};</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="namespacens3_1_1millicar.html#a25539d52b47e173ea46e1566f63d2d19">   66</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacens3_1_1millicar.html#a25539d52b47e173ea46e1566f63d2d19">sqrtC_UMi_NLOS</a>[6][6] = {</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  {1, 0, 0, 0, 0, 0},</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  {-0.7, 0.714143, 0, 0, 0, 0},</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  {0, 0, 1, 0, 0, 0},</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  {-0.4, 0.168034, 0, 0.90098, 0, 0},</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  {0, -0.70014, 0.5, 0.130577, 0.4927, 0},</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  {0, 0, 0.5, 0.221981, -0.566238, 0.616522},</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="namespacens3_1_1millicar.html#a811ce0ccc8915ec30746ba0ddde6349f">   75</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacens3_1_1millicar.html#a811ce0ccc8915ec30746ba0ddde6349f">oxygen_loss</a>[17][2] = {</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  {52.0e9, 0.0},</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  {53.0e9, 1.0},</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  {54.0e9, 2.2},</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  {55.0e9, 4.0},</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  {56.0e9, 6.6},</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  {57.0e9, 9.7},</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  {58.0e9, 12.6},</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  {59.0e9, 14.6},</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  {60.0e9, 15.0},</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  {61.0e9, 14.6},</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  {62.0e9, 14.3},</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  {63.0e9, 10.5},</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  {64.0e9, 6.8},</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  {65.0e9, 3.9},</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  {66.0e9, 1.9},</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  {67.0e9, 1.0},</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  {68.0e9, 0.0}</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;};</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a9cb94e871be75a415ffd92015793a535">   95</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a9cb94e871be75a415ffd92015793a535">MmWaveVehicularSpectrumPropagationLossModel::MmWaveVehicularSpectrumPropagationLossModel</a> ()</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;{</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a> = CreateObject&lt;UniformRandomVariable&gt; ();</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f090b456c94c6f826df5c39df80ddcc">m_uniformRvBlockage</a> = CreateObject&lt;UniformRandomVariable&gt; ();</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a369db033235d504e201cb2ab7f509e50">m_expRv</a> = CreateObject&lt;ExponentialRandomVariable&gt; ();</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a> = CreateObject&lt;NormalRandomVariable&gt; ();</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  m_normalRv-&gt;SetAttribute (<span class="stringliteral">&quot;Mean&quot;</span>, DoubleValue (0));</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  m_normalRv-&gt;SetAttribute (<span class="stringliteral">&quot;Variance&quot;</span>, DoubleValue (1));</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">m_normalRvBlockage</a> = CreateObject&lt;NormalRandomVariable&gt; ();</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">m_normalRvBlockage</a>-&gt;SetAttribute (<span class="stringliteral">&quot;Mean&quot;</span>, DoubleValue (0));</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">m_normalRvBlockage</a>-&gt;SetAttribute (<span class="stringliteral">&quot;Variance&quot;</span>, DoubleValue (1));</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;}</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;TypeId</div><div class="line"><a name="l00109"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ae0e9dd0e9bf2c545e5673b18275b9321">  109</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ae0e9dd0e9bf2c545e5673b18275b9321">MmWaveVehicularSpectrumPropagationLossModel::GetTypeId</a> (<span class="keywordtype">void</span>)</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;{</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keyword">static</span> TypeId tid = TypeId (<span class="stringliteral">&quot;ns3::MmWaveVehicularSpectrumPropagationLossModel&quot;</span>)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    .SetParent&lt;SpectrumPropagationLossModel&gt; ()</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    .AddConstructor&lt;MmWaveVehicularSpectrumPropagationLossModel&gt; ()</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;Frequency&quot;</span>,</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                   <span class="stringliteral">&quot;Operating frequency in Hz&quot;</span>,</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                   DoubleValue (0.0),</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                   MakeDoubleAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a0f59e8c2b0fa28ae37e2f239b6abaa1b">MmWaveVehicularSpectrumPropagationLossModel::SetFrequency</a>,</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                                       &amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad9fb12c1bb96aa3bbd3eb676cdfa855f">MmWaveVehicularSpectrumPropagationLossModel::GetFrequency</a>),</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                   MakeDoubleChecker&lt;double&gt; ())</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;UpdatePeriod&quot;</span>,</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                   <span class="stringliteral">&quot;Enable spatially-consistent UT mobility modeling procedure A, the update period unit is in ms, set to 0 ms to disable update&quot;</span>,</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                   TimeValue (MilliSeconds (1)),</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                   MakeTimeAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">MmWaveVehicularSpectrumPropagationLossModel::m_updatePeriod</a>),</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                   MakeTimeChecker ())</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;Blockage&quot;</span>,</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                   <span class="stringliteral">&quot;Enable blockage model A (sec 7.6.4.1)&quot;</span>,</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                   BooleanValue (<span class="keyword">false</span>),</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                   MakeBooleanAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a576e8ac3fb04ac54bde5f903058e2295">MmWaveVehicularSpectrumPropagationLossModel::m_blockage</a>),</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                   MakeBooleanChecker ())</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;NumNonselfBlocking&quot;</span>,</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                   <span class="stringliteral">&quot;number of non-self-blocking regions&quot;</span>,</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                   IntegerValue (4),</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                   MakeIntegerAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a89d7731418073cbb202fa541c4ecec7d">MmWaveVehicularSpectrumPropagationLossModel::m_numNonSelfBloking</a>),</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                   MakeIntegerChecker&lt;uint16_t&gt; ())</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;BlockerSpeed&quot;</span>,</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                   <span class="stringliteral">&quot;The speed of moving blockers, the unit is m/s&quot;</span>,</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                   DoubleValue (1),</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                   MakeDoubleAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">MmWaveVehicularSpectrumPropagationLossModel::m_blockerSpeed</a>),</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                   MakeDoubleChecker&lt;double&gt; ())</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;PortraitMode&quot;</span>,</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                   <span class="stringliteral">&quot;true for portrait mode, false for landscape mode&quot;</span>,</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                   BooleanValue (<span class="keyword">true</span>),</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                   MakeBooleanAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#acec66837359b46f1d0c8b28167aa9b45">MmWaveVehicularSpectrumPropagationLossModel::m_portraitMode</a>),</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                   MakeBooleanChecker ())</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;OxygenAbsorption&quot;</span>,</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                   <span class="stringliteral">&quot;true for considering oxygen absortion, false for not considering it&quot;</span>,</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                   BooleanValue (<span class="keyword">true</span>),</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                   MakeBooleanAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5fa94085c9a8f8f8e3c4158c08fd5486">MmWaveVehicularSpectrumPropagationLossModel::m_oxygenAbsorption</a>),</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                   MakeBooleanChecker ())</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    .AddAttribute (<span class="stringliteral">&quot;O2I&quot;</span>,</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                   <span class="stringliteral">&quot;Outdoor to Indoor channel state&quot;</span>,</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                   BooleanValue (<span class="keyword">false</span>),</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                   MakeBooleanAccessor (&amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac2676ed5f8eac0a95bafd6ceb08c57c3">MmWaveVehicularSpectrumPropagationLossModel::m_o2i</a>),</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                   MakeBooleanChecker ())</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  ;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="keywordflow">return</span> tid;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;}</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaa3809b4d4d0731f2206b71a0d5d9d9c">  159</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaa3809b4d4d0731f2206b71a0d5d9d9c">MmWaveVehicularSpectrumPropagationLossModel::~MmWaveVehicularSpectrumPropagationLossModel</a> ()</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;{</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;}</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="keywordtype">void</span></div><div class="line"><a name="l00165"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a31388e68c063456d30daf210783b5f62">  165</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a31388e68c063456d30daf210783b5f62">MmWaveVehicularSpectrumPropagationLossModel::DoDispose</a> ()</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;{</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  NS_LOG_FUNCTION (<span class="keyword">this</span>);</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;}</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keywordtype">void</span></div><div class="line"><a name="l00171"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ab2c520f59106e0e7a919d6c724a8dd96">  171</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ab2c520f59106e0e7a919d6c724a8dd96">MmWaveVehicularSpectrumPropagationLossModel::AddDevice</a> (Ptr&lt;NetDevice&gt; dev, Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; antenna)</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;{</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  NS_ASSERT_MSG (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.find (dev) == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.end (), <span class="stringliteral">&quot;Device is already present in the map&quot;</span>);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.insert (std::pair &lt;Ptr&lt;NetDevice&gt;, Ptr&lt;MmWaveVehicularAntennaArrayModel&gt;&gt; (dev, antenna));</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;}</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;Ptr&lt;SpectrumValue&gt;</div><div class="line"><a name="l00178"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad4b12bbb003fe17d35474738a4f42d82">  178</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad4b12bbb003fe17d35474738a4f42d82">MmWaveVehicularSpectrumPropagationLossModel::DoCalcRxPowerSpectralDensity</a> (Ptr&lt;const SpectrumValue&gt; txPsd,</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                                                 Ptr&lt;const MobilityModel&gt; a,</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                                                 Ptr&lt;const MobilityModel&gt; b)<span class="keyword"> const</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  NS_LOG_FUNCTION (<span class="keyword">this</span>);</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="comment">// check if the frequency is correctly set</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  NS_ASSERT_MSG (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a> != 0.0, <span class="stringliteral">&quot;Set the operating frequency first!&quot;</span>);</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  Ptr&lt;SpectrumValue&gt; rxPsd = Copy (txPsd);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  Ptr&lt;NetDevice&gt; txDevice = a-&gt;GetObject&lt;Node&gt; ()-&gt;GetDevice (0);</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  Ptr&lt;NetDevice&gt; rxDevice = b-&gt;GetObject&lt;Node&gt; ()-&gt;GetDevice (0);</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  Vector locUT = b-&gt;GetPosition (); <span class="comment">// TODO change this</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="comment">// retrieve the antenna of the tx device</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  NS_ASSERT_MSG (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.find (txDevice) != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.end (), <span class="stringliteral">&quot;Antenna not found for device &quot;</span> &lt;&lt; txDevice);</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; txAntennaArray = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.at (txDevice);</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;tx dev &quot;</span> &lt;&lt; txDevice &lt;&lt; <span class="stringliteral">&quot; antenna &quot;</span> &lt;&lt; txAntennaArray);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="comment">// retrieve the antenna of the rx device</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  NS_ASSERT_MSG (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.find (txDevice) != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.end (), <span class="stringliteral">&quot;Antenna not found for device &quot;</span> &lt;&lt; rxDevice);</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; rxAntennaArray = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">m_deviceAntennaMap</a>.at (rxDevice);</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;rx dev &quot;</span> &lt;&lt; rxDevice &lt;&lt; <span class="stringliteral">&quot; antenna &quot;</span> &lt;&lt; rxAntennaArray);</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="comment">/* txAntennaNum[0]-number of vertical antenna elements</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">   * txAntennaNum[1]-number of horizontal antenna elements*/</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="comment">// NOTE: only squared antenna arrays are currently supported</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  uint16_t txAntennaNum[2];</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  txAntennaNum[0] = sqrt (txAntennaArray-&gt;GetTotNoArrayElements ());</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  txAntennaNum[1] = txAntennaNum[0];</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;number of tx antenna elements &quot;</span> &lt;&lt; txAntennaNum[0] &lt;&lt; <span class="stringliteral">&quot; x &quot;</span> &lt;&lt; txAntennaNum[1]);</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  uint16_t rxAntennaNum[2];</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  rxAntennaNum[0] = sqrt (rxAntennaArray-&gt;GetTotNoArrayElements ());</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  rxAntennaNum[1] = rxAntennaNum[0];</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;number of rx antenna elements &quot;</span> &lt;&lt; rxAntennaNum[0] &lt;&lt; <span class="stringliteral">&quot; x &quot;</span> &lt;&lt; rxAntennaNum[1]);</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordflow">if</span> (txAntennaArray-&gt;IsOmniTx () || rxAntennaArray-&gt;IsOmniTx () )</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    {</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      NS_LOG_LOGIC (<span class="stringliteral">&quot;Omni transmission, do nothing.&quot;</span>);</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <span class="keywordflow">return</span> rxPsd;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    }</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  NS_ASSERT_MSG (a-&gt;GetDistanceFrom (b) != 0, <span class="stringliteral">&quot;The position of tx and rx devices cannot be the same&quot;</span>);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  Vector rxSpeed = b-&gt;GetVelocity ();</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  Vector txSpeed = a-&gt;GetVelocity ();</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  Vector relativeSpeed (rxSpeed.x - txSpeed.x,rxSpeed.y - txSpeed.y,rxSpeed.z - txSpeed.z);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#ac0dcf0a6942bb2f2d264bce535346f31">key_t</a> key = std::make_pair (txDevice,rxDevice);</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#ac0dcf0a6942bb2f2d264bce535346f31">key_t</a> keyReverse = std::make_pair (rxDevice,txDevice);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  std::map&lt; key_t, Ptr&lt;Params3gpp&gt; &gt;::iterator it = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.find (key);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  std::map&lt; key_t, Ptr&lt;Params3gpp&gt; &gt;::iterator itReverse = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.find (keyReverse);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  Ptr&lt;Params3gpp&gt; channelParams;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="comment">//Step 2: Assign propagation condition (LOS/NLOS).</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keywordtype">char</span> condition;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  <span class="keywordflow">if</span> (DynamicCast&lt;MmWaveVehicularPropagationLossModel&gt; (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">m_3gppPathloss</a>) != 0)</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      condition = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">m_3gppPathloss</a>-&gt;GetObject&lt;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_propagation_loss_model.html">MmWaveVehicularPropagationLossModel</a>&gt; ()</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        -&gt;GetChannelCondition (a-&gt;GetObject&lt;MobilityModel&gt; (),b-&gt;GetObject&lt;MobilityModel&gt; ());</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    }</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="comment">// else if (DynamicCast&lt;MmWave3gppBuildingsPropagationLossModel&gt; (m_3gppPathloss) != 0)</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="comment">//   {</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">//     condition = m_3gppPathloss-&gt;GetObject&lt;MmWave3gppBuildingsPropagationLossModel&gt; ()</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="comment">//       -&gt;GetChannelCondition (a-&gt;GetObject&lt;MobilityModel&gt; (),b-&gt;GetObject&lt;MobilityModel&gt; ());</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="comment">//   }</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    {</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      NS_FATAL_ERROR (<span class="stringliteral">&quot;unknown pathloss model&quot;</span>);</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    }</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keywordtype">bool</span> o2i = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac2676ed5f8eac0a95bafd6ceb08c57c3">m_o2i</a>; <span class="comment">// In the current implementation the O2I state is manually</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                    <span class="comment">// configured.</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="comment">//Every m_updatedPeriod, the channel matrix is deleted and a consistent channel update is triggered.</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="comment">//When there is a LOS/NLOS switch, a new uncorrelated channel is created.</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="comment">//Therefore, LOS/NLOS condition of updating is always consistent with the previous channel.</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="comment">//I only update the forward channel.</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keywordflow">if</span> ((it == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; itReverse == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end ())</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;      || (it != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; it-&gt;second-&gt;m_channel.size () == 0)</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;      || (it != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; it-&gt;second-&gt;m_condition != condition)</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      || (itReverse != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; itReverse-&gt;second-&gt;m_channel.size () == 0)</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      || (itReverse != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; itReverse-&gt;second-&gt;m_condition != condition))</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    {</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      NS_LOG_INFO (<span class="stringliteral">&quot;Update or create the forward channel&quot;</span>);</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      NS_LOG_LOGIC (<span class="stringliteral">&quot;it == m_channelMap.end () &quot;</span> &lt;&lt; (it == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end ()));</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      NS_LOG_LOGIC (<span class="stringliteral">&quot;itReverse == m_channelMap.end () &quot;</span> &lt;&lt; (itReverse == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end ()));</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      NS_LOG_LOGIC (<span class="stringliteral">&quot;it-&gt;second-&gt;m_channel.size() == 0 &quot;</span> &lt;&lt; (it-&gt;second-&gt;m_channel.size () == 0));</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      NS_LOG_LOGIC (<span class="stringliteral">&quot;it-&gt;second-&gt;m_condition != condition&quot;</span> &lt;&lt; (it-&gt;second-&gt;m_condition != condition));</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      <span class="comment">//Step 1: The parameters are configured in the example code.</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      <span class="comment">/*make sure txAngle rxAngle exist, i.e., the position of tx and rx cannot be the same*/</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;      Angles txAngle (b-&gt;GetPosition (), a-&gt;GetPosition ());</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      Angles rxAngle (a-&gt;GetPosition (), b-&gt;GetPosition ());</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;txAngle  &quot;</span> &lt;&lt; txAngle.phi &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; txAngle.theta);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;rxAngle &quot;</span> &lt;&lt; rxAngle.phi &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; rxAngle.theta);</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      txAngle.phi = txAngle.phi - txAntennaArray-&gt;GetOffset ();          <span class="comment">//adjustment of the angles due to multi-sector consideration</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;txAngle with offset PHI &quot;</span> &lt;&lt; txAngle.phi);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      rxAngle.phi = rxAngle.phi - rxAntennaArray-&gt;GetOffset ();</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;rxAngle with offset PHI &quot;</span> &lt;&lt; rxAngle.phi);</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="comment">//Step 2: Assign propagation condition (LOS/NLOS).</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      <span class="comment">//los, o2i condition is computed above.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;      <span class="comment">//Step 3: The propagation loss is handled in the mmWavePropagationLossModel class.</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;      <span class="keywordtype">double</span> x = a-&gt;GetPosition ().x - b-&gt;GetPosition ().x;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      <span class="keywordtype">double</span> y = a-&gt;GetPosition ().y - b-&gt;GetPosition ().y;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keywordtype">double</span> distance2D = sqrt (x * x + y * y);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="keywordtype">double</span> hTx = a-&gt;GetPosition ().z;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="keywordtype">double</span> hRx = b-&gt;GetPosition ().z;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      <span class="comment">//Draw parameters from table 7.5-6 and 7.5-7 to 7.5-10.</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      Ptr&lt;ParamsTable&gt; table3gpp = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad52c589c90a8cb399316c69f189c054e">Get3gppTable</a> (condition, o2i, hTx, hRx, distance2D);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="comment">// Step 4-11 are performed in function GetNewChannel()</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="keywordflow">if</span> ((it == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; itReverse == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end ())</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;          || (it != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; it-&gt;second-&gt;m_channel.size () == 0))</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;          <span class="comment">//delete the channel parameter to cause the channel to be updated again.</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;          <span class="comment">//The m_updatePeriod can be configured to be relatively large in order to disable updates.</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">m_updatePeriod</a>.GetMilliSeconds () &gt; 0)</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            {</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;              NS_LOG_INFO (<span class="stringliteral">&quot;Time &quot;</span> &lt;&lt; Simulator::Now ().GetSeconds () &lt;&lt; <span class="stringliteral">&quot; schedule delete for a &quot;</span> &lt;&lt; a-&gt;GetPosition () &lt;&lt; <span class="stringliteral">&quot; b &quot;</span> &lt;&lt; b-&gt;GetPosition ()</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                                   &lt;&lt; <span class="stringliteral">&quot; m_updatePeriod &quot;</span> &lt;&lt; <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">m_updatePeriod</a>.GetSeconds ());</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;              Simulator::Schedule (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">m_updatePeriod</a>, &amp;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5d94006c357d5469d5ac24c1796f919a">MmWaveVehicularSpectrumPropagationLossModel::DeleteChannel</a>,<span class="keyword">this</span>,a,b);</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            }</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        }</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      <span class="keywordtype">double</span> distance3D = a-&gt;GetDistanceFrom (b);</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <span class="keywordtype">bool</span> channelUpdate = <span class="keyword">false</span>;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      <span class="keywordflow">if</span> (it != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end () &amp;&amp; it-&gt;second-&gt;m_channel.size () == 0)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        {</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;          <span class="comment">//if the channel map is not empty, we only update the channel.</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;          NS_LOG_DEBUG (<span class="stringliteral">&quot;Update forward channel consistently between MobilityModel &quot;</span> &lt;&lt; a &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; b);</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;          it-&gt;second-&gt;m_locUT = locUT;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;          it-&gt;second-&gt;m_condition = condition;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;          it-&gt;second-&gt;m_o2i = o2i;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;          channelParams = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaddcd856c8a98280eea9b628315a5f87">UpdateChannel</a> (it-&gt;second, table3gpp, txAntennaArray, rxAntennaArray,</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                                         txAntennaNum, rxAntennaNum, rxAngle, txAngle);</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;          it-&gt;second-&gt;m_dis3D = distance3D;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;          it-&gt;second-&gt;m_dis2D = distance2D;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;          it-&gt;second-&gt;m_speed = relativeSpeed;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;          it-&gt;second-&gt;m_generatedTime = Now ();</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;          it-&gt;second-&gt;m_preLocUT = locUT;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;          channelUpdate = <span class="keyword">true</span>;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        }</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;          <span class="comment">//if the channel map is empty, we create a new channel.</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;          NS_LOG_INFO (<span class="stringliteral">&quot;Create new channel&quot;</span>);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;          channelParams = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a96792d5f699d7d1b86739cdb823c898f">GetNewChannel</a> (table3gpp, locUT, condition, o2i, txAntennaArray, rxAntennaArray,</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                                         txAntennaNum, rxAntennaNum, rxAngle, txAngle, relativeSpeed, distance2D, distance3D);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        }</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot; --- UPDATE BF VECTOR and LONGTERM vectors --- for new or update? &quot;</span> &lt;&lt; channelUpdate);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="comment">// insert the channelParams in the map</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>[key] = channelParams;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    }</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (itReverse == <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end ())                       <span class="comment">// Find channel matrix in the forward link</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    {</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      channelParams = (*it).second;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;No need to update the channel&quot;</span>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    }</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordflow">else</span>                       <span class="comment">// Find channel matrix in the Reverse link</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      channelParams = (*itReverse).second;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      NS_LOG_DEBUG (<span class="stringliteral">&quot;No need to update the channel&quot;</span>);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    }</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  <span class="comment">// for now, store these BF vectors so that CalLongTerm can use them</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  channelParams-&gt;m_txW = txAntennaArray-&gt;GetBeamformingVectorPanel ();</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  channelParams-&gt;m_rxW = rxAntennaArray-&gt;GetBeamformingVectorPanel ();</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="comment">// call CalLongTerm, and get the longTerm params</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keyword">auto</span> longTerm = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a1a622ae8949ee4a07881d5afc960b4fa">CalLongTerm</a> (channelParams);</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  channelParams-&gt;m_longTerm = longTerm;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  Ptr&lt;SpectrumValue&gt; bfPsd = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a941200314c689b92cec1e37e96b9642e">CalBeamformingGain</a> (rxPsd, channelParams, longTerm, rxSpeed, txSpeed);</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  SpectrumValue bfGain = (*bfPsd) / (*rxPsd);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  uint8_t nbands = bfGain.GetSpectrumModel ()-&gt;GetNumBands ();</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;****** BF gain == &quot;</span> &lt;&lt; Sum (bfGain) / nbands &lt;&lt; <span class="stringliteral">&quot; RX PSD &quot;</span> &lt;&lt; Sum (*rxPsd) / nbands</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                                        &lt;&lt; <span class="stringliteral">&quot; a pos &quot;</span> &lt;&lt; a-&gt;GetPosition ()</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                                        &lt;&lt; <span class="stringliteral">&quot; a antenna ID &quot;</span> &lt;&lt; txAntennaArray-&gt;GetPlanesId ()</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                                        &lt;&lt; <span class="stringliteral">&quot; b pos &quot;</span> &lt;&lt; b-&gt;GetPosition ()</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                                        &lt;&lt; <span class="stringliteral">&quot; b antenna ID &quot;</span> &lt;&lt; rxAntennaArray-&gt;GetPlanesId ());</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordflow">return</span> bfPsd;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;}</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;Ptr&lt;SpectrumValue&gt;</div><div class="line"><a name="l00382"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a941200314c689b92cec1e37e96b9642e">  382</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a941200314c689b92cec1e37e96b9642e">MmWaveVehicularSpectrumPropagationLossModel::CalBeamformingGain</a> (Ptr&lt;const SpectrumValue&gt; txPsd, Ptr&lt;Params3gpp&gt; params,</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                                       <a class="code" href="namespacens3_1_1millicar.html#add0635c95bb7071713fa1491eb5b6bbf">complexVector_t</a> longTerm, Vector rxSpeed, Vector txSpeed)<span class="keyword"> const</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  NS_LOG_FUNCTION (<span class="keyword">this</span>);</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  Ptr&lt;SpectrumValue&gt; tempPsd = Copy&lt;SpectrumValue&gt; (txPsd);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="comment">//NS_ASSERT_MSG (params-&gt;m_delay.size()==params-&gt;m_channel.at(0).at(0).size(), &quot;the cluster number of channel and delay spread should be the same&quot;);</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="comment">//NS_ASSERT_MSG (params-&gt;m_txW.size()==params-&gt;m_channel.at(0).size(), &quot;the tx antenna size of channel and antenna weights should be the same&quot;);</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="comment">//NS_ASSERT_MSG (params-&gt;m_rxW.size()==params-&gt;m_channel.size(), &quot;the rx antenna size of channel and antenna weights should be the same&quot;);</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="comment">//NS_ASSERT_MSG (params-&gt;m_angle.at(0).size()==params-&gt;m_channel.at(0).at(0).size(), &quot;the cluster number of channel and AOA should be the same&quot;);</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="comment">//NS_ASSERT_MSG (params-&gt;m_angle.at(1).size()==params-&gt;m_channel.at(0).at(0).size(), &quot;the cluster number of channel and ZOA should be the same&quot;);</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="comment">//channel[rx][tx][cluster]</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  uint8_t numCluster = params-&gt;m_numCluster;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="comment">//uint8_t txAntenna = params-&gt;m_txW.size();</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="comment">//uint8_t rxAntenna = params-&gt;m_rxW.size();</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="comment">//the update of Doppler is simplified by only taking the center angle of each cluster in to consideration.</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  Values::iterator vit = tempPsd-&gt;ValuesBegin ();</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  Bands::const_iterator sbit = tempPsd-&gt;ConstBandsBegin(); <span class="comment">// sub band iterator</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordtype">double</span> slotTime = Simulator::Now ().GetSeconds ();</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#add0635c95bb7071713fa1491eb5b6bbf">complexVector_t</a> doppler;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numCluster; cIndex++)</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    {</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      <span class="keywordtype">double</span> alpha = 0.0, D = 0.0, vScatt = 0.0, delayedPathsTerm = 0.0; <span class="comment">// parameters used to evaluate Doppler effect in delayed paths as described in p. 32 of TR 37.885</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keywordflow">if</span>(cIndex != 0)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        {</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;         <span class="keywordflow">if</span>(<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;V2V-Highway&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;Extended-V2V-Highway&quot;</span>)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;         {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;          vScatt = 140/3.6; <span class="comment">// maximum speed in highway scenario, converted in m/s to be consistent with other speed measures</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;         }</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;V2V-Urban&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;Extended-V2V-Urban&quot;</span>)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;         {</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;          vScatt = 60/3.6; <span class="comment">// maximum speed in urban scenario, converted in m/s to be consistent with other speed measures</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;         }</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;         D = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue(-vScatt, vScatt);</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;         alpha = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue(0, 1);</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;         delayedPathsTerm = 2 * alpha * D;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        }</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;      <span class="comment">//cluster angle angle[direction][n],where, direction = 0(aoa), 1(zoa).</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      <span class="comment">//</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      <span class="keywordtype">double</span> temp_doppler = 2 * M_PI * ((sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex) * M_PI / 180) * cos (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>).at (cIndex) * M_PI / 180) * rxSpeed.x</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                                        + sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex) * M_PI / 180) * sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>).at (cIndex) * M_PI / 180) * rxSpeed.y</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                                        + cos (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex) * M_PI / 180) * rxSpeed.z)</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                                        + (sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>).at (cIndex) * M_PI / 180) * cos (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>).at (cIndex) * M_PI / 180) * txSpeed.x</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                                        + sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>).at (cIndex) * M_PI / 180) * sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>).at (cIndex) * M_PI / 180) * txSpeed.y</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                                        + cos (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>).at (cIndex) * M_PI / 180) * txSpeed.z) + delayedPathsTerm)</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                                        * slotTime * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a> / 3e8;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      doppler.push_back (exp (std::complex&lt;double&gt; (0, temp_doppler)));</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    }</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keywordflow">while</span> (vit != tempPsd-&gt;ValuesEnd ())</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    {</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      std::complex&lt;double&gt; subsbandGain (0.0,0.0);</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      <span class="keywordflow">if</span> ((*vit) != 0.00)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        {</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;          <span class="keywordtype">double</span> fsb = (*sbit).fc;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;          <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numCluster; cIndex++)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            {</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;              <span class="keywordtype">double</span> delay = -2 * M_PI * fsb * (params-&gt;m_delay.at (cIndex));</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;              <span class="keywordtype">double</span> tauDelta = 0.0;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;              <span class="keywordflow">if</span>(cIndex != 0)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;              {</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                tauDelta = params-&gt;m_tauDelta; <span class="comment">// when in LOS condition, tau_{\Delta} is equal to zero.</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;              }</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;              <span class="keywordflow">if</span>(!<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5fa94085c9a8f8f8e3c4158c08fd5486">m_oxygenAbsorption</a>)</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;              {</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                subsbandGain = subsbandGain + longTerm.at (cIndex) * doppler.at (cIndex) * exp (std::complex&lt;double&gt; (0, delay));</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;              }</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;              {</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                subsbandGain = subsbandGain + longTerm.at (cIndex) * doppler.at (cIndex) * exp (std::complex&lt;double&gt; (0, delay)) / <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a2acc37751643e20c1f2f34ccd3167c7d">GetOxygenLoss</a>(fsb, params-&gt;m_dis3D, params-&gt;m_delay.at (cIndex), tauDelta);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;              }</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            }</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;          *vit = (*vit) * (norm (subsbandGain));</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      vit++;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      sbit++;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    }</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordflow">return</span> tempPsd;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;}</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l00474"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a2acc37751643e20c1f2f34ccd3167c7d">  474</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a2acc37751643e20c1f2f34ccd3167c7d">MmWaveVehicularSpectrumPropagationLossModel::GetOxygenLoss</a> (<span class="keywordtype">double</span> f, <span class="keywordtype">double</span> dist3D, <span class="keywordtype">double</span> tau, <span class="keywordtype">double</span> tauDelta)<span class="keyword"> const</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  NS_LOG_FUNCTION (<span class="keyword">this</span> &lt;&lt; f &lt;&lt; dist3D &lt;&lt; tau &lt;&lt; tauDelta);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <span class="keywordtype">double</span> alpha = 0.0, loss = 0.0;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keywordflow">if</span>(f &gt; oxygen_loss[0][0] &amp;&amp; f &lt; oxygen_loss[16][0])</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  {</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">for</span> (uint8_t idx = 1; idx &lt;= 15; idx++)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    {</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      <span class="keywordflow">if</span> ( f &gt; oxygen_loss[idx-1][0] &amp;&amp; f &lt;= oxygen_loss[idx][0] )</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      {</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="comment">// interpolation of the oxygen_loss table</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        alpha = (oxygen_loss[idx][1] - oxygen_loss[idx-1][1])/(oxygen_loss[idx][0] - oxygen_loss[idx-1][0])*(f - oxygen_loss[idx-1][0]) + oxygen_loss[idx-1][1];</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        loss = alpha / 1e3 * (dist3D + 3e8 * (tau + tauDelta));</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        NS_LOG_DEBUG (<span class="stringliteral">&quot;f (subband) &quot;</span> &lt;&lt; f &lt;&lt; <span class="stringliteral">&quot; alpha &quot;</span> &lt;&lt; alpha &lt;&lt; <span class="stringliteral">&quot; dB/km loss &quot;</span> &lt;&lt; loss &lt;&lt; <span class="stringliteral">&quot; dB&quot;</span>);</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      }</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    }</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  }</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keywordflow">return</span> pow(10.0, loss/10); <span class="comment">// need to obtain the linear term, since in TR 38.901 the formula is in dB</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;}</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordtype">void</span></div><div class="line"><a name="l00498"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a87bc2bb292dc183649be9046062f3648">  498</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a87bc2bb292dc183649be9046062f3648">MmWaveVehicularSpectrumPropagationLossModel::SetPathlossModel</a> (Ptr&lt;PropagationLossModel&gt; pathloss)</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;{</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">m_3gppPathloss</a> = pathloss;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">if</span> (DynamicCast&lt;MmWaveVehicularPropagationLossModel&gt; (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">m_3gppPathloss</a>) != 0)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    {</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;      <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">m_3gppPathloss</a>-&gt;GetObject&lt;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_propagation_loss_model.html">MmWaveVehicularPropagationLossModel</a>&gt; ()-&gt;GetScenario ();</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    }</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="comment">// else if (DynamicCast&lt;MmWave3gppBuildingsPropagationLossModel&gt; (m_3gppPathloss) != 0)</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="comment">//   {</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="comment">//     m_scenario = m_3gppPathloss-&gt;GetObject&lt;MmWave3gppBuildingsPropagationLossModel&gt; ()-&gt;GetScenario ();</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="comment">//   }</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    {</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;      NS_FATAL_ERROR (<span class="stringliteral">&quot;unknown pathloss model&quot;</span>);</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    }</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;}</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<a class="code" href="namespacens3_1_1millicar.html#add0635c95bb7071713fa1491eb5b6bbf">complexVector_t</a></div><div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a1a622ae8949ee4a07881d5afc960b4fa">  517</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a1a622ae8949ee4a07881d5afc960b4fa">MmWaveVehicularSpectrumPropagationLossModel::CalLongTerm</a> (Ptr&lt;Params3gpp&gt; params)<span class="keyword"> const</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  uint16_t txAntenna = params-&gt;m_txW.size ();</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  uint16_t rxAntenna = params-&gt;m_rxW.size ();</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  NS_LOG_DEBUG (<span class="stringliteral">&quot;CalLongTerm with txAntenna &quot;</span> &lt;&lt; (uint16_t)txAntenna &lt;&lt; <span class="stringliteral">&quot; rxAntenna &quot;</span> &lt;&lt; (uint16_t)rxAntenna);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="comment">//store the long term part to reduce computation load</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="comment">//only the small scale fading is need to be updated if the large scale parameters and antenna weights remain unchanged.</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#add0635c95bb7071713fa1491eb5b6bbf">complexVector_t</a> longTerm;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  uint8_t numCluster = params-&gt;m_numCluster;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numCluster; cIndex++)</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    {</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      std::complex&lt;double&gt; txSum (0,0);</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;      <span class="keywordflow">for</span> (uint16_t txIndex = 0; txIndex &lt; txAntenna; txIndex++)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        {</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;          std::complex&lt;double&gt; rxSum (0,0);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;          <span class="keywordflow">for</span> (uint16_t rxIndex = 0; rxIndex &lt; rxAntenna; rxIndex++)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            {</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;              rxSum = rxSum + params-&gt;m_rxW.at (rxIndex) * params-&gt;m_channel.at (rxIndex).at (txIndex).at (cIndex);</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            }</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;          txSum = txSum + params-&gt;m_txW.at (txIndex) * rxSum;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        }</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      longTerm.push_back (txSum);</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    }</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordflow">return</span> longTerm;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;}</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;Ptr&lt;ParamsTable&gt;</div><div class="line"><a name="l00547"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad52c589c90a8cb399316c69f189c054e">  547</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad52c589c90a8cb399316c69f189c054e">MmWaveVehicularSpectrumPropagationLossModel::Get3gppTable</a> (<span class="keywordtype">char</span> condition, <span class="keywordtype">bool</span> o2i, <span class="keywordtype">double</span> hBS, <span class="keywordtype">double</span> hUT, <span class="keywordtype">double</span> distance2D)<span class="keyword"> const</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="keywordtype">double</span> fcGHz = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a> / 1e9;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  Ptr&lt;ParamsTable&gt; table3gpp = CreateObject&lt;ParamsTable&gt; ();</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  <span class="comment">// table3gpp includes the following parameters:</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="comment">// numOfCluster, raysPerCluster, uLgDS, sigLgDS, uLgASD, sigLgASD,</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="comment">// uLgASA, sigLgASA, uLgZSA, sigLgZSA, uLgZSD, sigLgZSD, offsetZOD,</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="comment">// cDS, cASD, cASA, cZSA, uK, sigK, rTau, shadowingStd</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="comment">//In NLOS case, parameter uK and sigK are not used and 0 is passed into the SetParams() function.</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;V2V-Urban&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;Extended-V2V-Urban&quot;</span>)</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    {</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;      <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;          table3gpp-&gt;SetParams (12, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                                20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                                -0.2 * log10 (1 + fcGHz) - 7.5, <span class="comment">// mu DS</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                                0.1, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 1.6, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                                0.1, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 1.6, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                                0.1, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 0.73, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.34, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 0.73, <span class="comment">// ZOD spread mu</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.34, <span class="comment">// ZOD spread sigma</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                                0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                                5, <span class="comment">// cluster DS</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                                17, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                                17, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                                7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                                3.48, <span class="comment">// K-factor mu</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                                2, <span class="comment">// K-factor sigma</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                                3, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                                4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;          <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 7; row++)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            {</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;              <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 7; column++)</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                {</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                  table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_LOS[row][column];</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                }</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            }</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        }</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;n&#39;</span>)</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        {</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;          table3gpp-&gt;SetParams (19, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                                20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                                -0.3 * log10 (1 + fcGHz) - 7, <span class="comment">// mu DS</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                                0.28, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                                -0.08 * log10 (1 + fcGHz) + 1.81, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                                0.05 * log10 (1 + fcGHz) + 0.3, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                                -0.08 * log10 (1 + fcGHz) + 1.81, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                                0.05 * log10 (1 + fcGHz) + 0.3, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                                -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOD spread mu</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                                -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOD spread sigma</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                                0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                                11, <span class="comment">// cluster DS</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                                22, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                                22, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                                7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                                0, <span class="comment">// K-factor mu NOTE this value is NA</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                                0, <span class="comment">// K-factor sigma NOTE this value is NA</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                                2.1, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                                4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;          <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 6; row++)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            {</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;              <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 6; column++)</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                {</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                  table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_NLOS[row][column];</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                }</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            }</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        }</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;v&#39;</span>)</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          table3gpp-&gt;SetParams (19, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                                20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                                -0.4 * log10 (1 + fcGHz) - 7, <span class="comment">// mu DS</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                                0.1, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 1.7, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                                0.1, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                                -0.1 * log10 (1 + fcGHz) + 1.7, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                                0.1, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                                -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                                -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOD spread mu</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                                -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOD spread sigma</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                                0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                                11, <span class="comment">// cluster DS</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                                22, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                                22, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                                7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                                0, <span class="comment">// K-factor mu</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                                4.5, <span class="comment">// K-factor sigma</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                                2.1, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                                4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 7; row++)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            {</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;              <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 7; column++)</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                {</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                  table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_LOS[row][column];</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                }</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            }</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        }</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        {</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;          NS_FATAL_ERROR (<span class="stringliteral">&quot;Unknown channel condition&quot;</span>);</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        }</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    }</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;V2V-Highway&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;Extended-V2V-Highway&quot;</span>)</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;  {</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      {</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        table3gpp-&gt;SetParams (12, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                              20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                              -8.3, <span class="comment">// mu DS</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                              0.2, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                              1.4, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                              0.1, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                              1.4, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                              0.1, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                              -0.1 * log10 (1 + fcGHz) + 0.73, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                              -0.04 * log10 (1 + fcGHz) + 0.34, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                              -0.1 * log10 (1 + fcGHz) + 0.73, <span class="comment">// ZOD spread mu</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                              -0.04 * log10 (1 + fcGHz) + 0.34, <span class="comment">// ZOD spread sigma</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                              0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                              5, <span class="comment">// cluster DS</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                              17, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                              17, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                              7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                              9, <span class="comment">// K-factor mu</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                              3.5, <span class="comment">// K-factor sigma</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                              3, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                              4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 7; row++)</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;          {</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 7; column++)</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;              {</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_LOS[row][column];</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;              }</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;          }</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      }</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;v&#39;</span>)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      {</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        table3gpp-&gt;SetParams (19, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                              20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                              -8.3, <span class="comment">// mu DS</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                              0.3, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                              1.5, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                              0.1, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                              1.5, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                              0.1, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                              -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                              -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                              -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOD spread mu</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                              -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOD spread sigma</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                              0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                              11, <span class="comment">// cluster DS</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                              22, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                              22, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                              7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                              0, <span class="comment">// K-factor mu</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                              4.5, <span class="comment">// K-factor sigma</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                              2.1, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                              4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 7; row++)</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;          {</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;            <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 7; column++)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;              {</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_LOS[row][column];</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;              }</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;          }</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      }</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;n&#39;</span>)</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      {</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        NS_LOG_WARN (<span class="stringliteral">&quot;The fast fading parameters for the NLOS condition in the (Extended)-V2V-Highway scenario are not defined in TR 37.885, use the ones defined in TDoc R1-1803671 instead&quot;</span>);</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        table3gpp-&gt;SetParams (19, <span class="comment">// number of clusters</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                              20, <span class="comment">// number of rays per cluster</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                              -7.66, <span class="comment">// mu DS</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                              -7.62, <span class="comment">// sigma DS</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                              1.32, <span class="comment">// AOD spread mu</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                              0.77, <span class="comment">// AOD spread sigma</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                              1.32, <span class="comment">// AOA spread mu</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                              0.77, <span class="comment">// AOA spread sigma</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                              -0.04 * log10 (1 + fcGHz) + 0.92, <span class="comment">// ZOA spread mu</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                              -0.07 * log10 (1 + fcGHz) + 0.41, <span class="comment">// ZOA spread sigma</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                              0, <span class="comment">// ZOD spread mu NOTE this is not defined in the TDoc</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                              0, <span class="comment">// ZOD spread sigma NOTE this is not defined in the TDoc</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                              0, <span class="comment">// ZOD offset</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                              0, <span class="comment">// cluster DS NOTE this is not defined in the TDoc</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                              10, <span class="comment">// cluster ASD</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                              22, <span class="comment">// cluster ASA</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                              7, <span class="comment">// cluster ZSA</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                              0, <span class="comment">// K-factor mu NOTE this is not defined in the TDoc</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                              0, <span class="comment">// K-factor sigma NOTE this is not defined in the TDoc</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                              2.1, <span class="comment">// delay scaling parameter</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                              4); <span class="comment">// per cluster shadowing std</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; 6; row++)</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;          {</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; 6; column++)</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;              {</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                table3gpp-&gt;m_sqrtC[row][column] = sqrtC_UMi_NLOS[row][column];</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;              }</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;          }</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      }</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;      {</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        NS_FATAL_ERROR (<span class="stringliteral">&quot;Unknown channel condition&quot;</span>);</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;      }</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  }</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    {</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;      <span class="comment">//Note that the InH-ShoppingMall scenario is not given in the table 7.5-6</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      NS_FATAL_ERROR (<span class="stringliteral">&quot;unkonw scenarios&quot;</span>);</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    }</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  <span class="keywordflow">return</span> table3gpp;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;}</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="keywordtype">void</span></div><div class="line"><a name="l00776"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5d94006c357d5469d5ac24c1796f919a">  776</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5d94006c357d5469d5ac24c1796f919a">MmWaveVehicularSpectrumPropagationLossModel::DeleteChannel</a> (Ptr&lt;const MobilityModel&gt; a, Ptr&lt;const MobilityModel&gt; b)<span class="keyword"> const</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  NS_LOG_FUNCTION (<span class="keyword">this</span>);</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  Ptr&lt;NetDevice&gt; dev1 = a-&gt;GetObject&lt;Node&gt; ()-&gt;GetDevice (0);</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;  Ptr&lt;NetDevice&gt; dev2 = b-&gt;GetObject&lt;Node&gt; ()-&gt;GetDevice (0);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;a position &quot;</span> &lt;&lt; a-&gt;GetPosition () &lt;&lt; <span class="stringliteral">&quot; b &quot;</span> &lt;&lt; b-&gt;GetPosition ());</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  Ptr&lt;Params3gpp&gt; params = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.find (std::make_pair (dev1,dev2))-&gt;second;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;params &quot;</span> &lt;&lt; params);</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;params m_channel size&quot;</span> &lt;&lt; params-&gt;m_channel.size ());</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  NS_ASSERT_MSG (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.find (std::make_pair (dev1,dev2)) != <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>.end (), <span class="stringliteral">&quot;Channel not found&quot;</span>);</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;  params-&gt;m_channel.clear ();</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">m_channelMap</a>[std::make_pair (dev1,dev2)] = params;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;}</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;Ptr&lt;Params3gpp&gt;</div><div class="line"><a name="l00791"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a96792d5f699d7d1b86739cdb823c898f">  791</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a96792d5f699d7d1b86739cdb823c898f">MmWaveVehicularSpectrumPropagationLossModel::GetNewChannel</a> (Ptr&lt;ParamsTable&gt;  table3gpp, Vector locUT, <span class="keywordtype">char</span> condition, <span class="keywordtype">bool</span> o2i,</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                                  Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; txAntenna, Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; rxAntenna,</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                                  uint16_t *txAntennaNum, uint16_t *rxAntennaNum,  Angles &amp;rxAngle, Angles &amp;txAngle,</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                                  Vector speed, <span class="keywordtype">double</span> dis2D, <span class="keywordtype">double</span> dis3D)<span class="keyword"> const</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  uint8_t numOfCluster = table3gpp-&gt;m_numOfCluster;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  uint8_t raysPerCluster = table3gpp-&gt;m_raysPerCluster;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  Ptr&lt;Params3gpp&gt; channelParams = Create&lt;Params3gpp&gt; ();</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="comment">//for new channel, the previous and current location is the same.</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  channelParams-&gt;m_preLocUT = locUT;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  channelParams-&gt;m_locUT = locUT;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  channelParams-&gt;m_condition = condition;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  channelParams-&gt;m_o2i = o2i;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  channelParams-&gt;m_generatedTime = Now ();</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  channelParams-&gt;m_speed = speed;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  channelParams-&gt;m_dis2D = dis2D;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  channelParams-&gt;m_dis3D = dis3D;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="comment">//Step 4: Generate large scale parameters. All LSPS are uncorrelated.</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> LSPsIndep, LSPs;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  uint8_t paramNum;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    {</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      paramNum = 7;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    }</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    {</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;      paramNum = 6;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    }</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;  <span class="comment">//Generate paramNum independent LSPs.</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  <span class="keywordflow">for</span> (uint8_t iter = 0; iter &lt; paramNum; iter++)</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    {</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      LSPsIndep.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue ());</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    }</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="keywordflow">for</span> (uint8_t row = 0; row &lt; paramNum; row++)</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    {</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      <span class="keywordtype">double</span> temp = 0;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      <span class="keywordflow">for</span> (uint8_t column = 0; column &lt; paramNum; column++)</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        {</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;          temp += table3gpp-&gt;m_sqrtC[row][column] * LSPsIndep.at (column);</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        }</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;      LSPs.push_back (temp);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    }</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;LSPsIndep:&quot;;</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; paramNum; i++)</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">          std::cout &lt;&lt;LSPsIndep.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;LSPs:&quot;;</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; paramNum; i++)</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment">          std::cout &lt;&lt;LSPs.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="comment">/* Notice the shadowing is updated much frequently (every transmission),</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">   * therefore it is generated separately in the 3GPP propagation loss model.*/</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  <span class="keywordtype">double</span> DS,ASD,ASA,ZSA,ZSD,K_factor = 0;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    {</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      K_factor = LSPs.at (1) * table3gpp-&gt;m_sigK + table3gpp-&gt;m_uK;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;      DS = pow (10, LSPs.at (2) * table3gpp-&gt;m_sigLgDS + table3gpp-&gt;m_uLgDS);</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;      ASD = pow (10, LSPs.at (3) * table3gpp-&gt;m_sigLgASD + table3gpp-&gt;m_uLgASD);</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      ASA = pow (10, LSPs.at (4) * table3gpp-&gt;m_sigLgASA + table3gpp-&gt;m_uLgASA);</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;      ZSD = pow (10, LSPs.at (5) * table3gpp-&gt;m_sigLgZSD + table3gpp-&gt;m_uLgZSD);</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;      ZSA = pow (10, LSPs.at (6) * table3gpp-&gt;m_sigLgZSA + table3gpp-&gt;m_uLgZSA);</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    }</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    {</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;      DS = pow (10, LSPs.at (1) * table3gpp-&gt;m_sigLgDS + table3gpp-&gt;m_uLgDS);</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      ASD = pow (10, LSPs.at (2) * table3gpp-&gt;m_sigLgASD + table3gpp-&gt;m_uLgASD);</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      ASA = pow (10, LSPs.at (3) * table3gpp-&gt;m_sigLgASA + table3gpp-&gt;m_uLgASA);</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      ZSD = pow (10, LSPs.at (4) * table3gpp-&gt;m_sigLgZSD + table3gpp-&gt;m_uLgZSD);</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      ZSA = pow (10, LSPs.at (5) * table3gpp-&gt;m_sigLgZSA + table3gpp-&gt;m_uLgZSA);</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    }</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  ASD = std::min (ASD, 104.0);</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  ASA = std::min (ASA, 104.0);</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  ZSD = std::min (ZSD, 52.0);</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  ZSA = std::min (ZSA, 52.0);</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  channelParams-&gt;m_DS = DS;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  channelParams-&gt;m_K = K_factor;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;K-factor=&quot;</span> &lt;&lt; K_factor &lt;&lt; <span class="stringliteral">&quot;,DS=&quot;</span> &lt;&lt; DS &lt;&lt; <span class="stringliteral">&quot;, ASD=&quot;</span> &lt;&lt; ASD &lt;&lt; <span class="stringliteral">&quot;, ASA=&quot;</span> &lt;&lt; ASA &lt;&lt; <span class="stringliteral">&quot;, ZSD=&quot;</span> &lt;&lt; ZSD &lt;&lt; <span class="stringliteral">&quot;, ZSA=&quot;</span> &lt;&lt; ZSA);</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="comment">//Step 5: Generate Delays.</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterDelay;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="keywordtype">double</span> minTau = 100.0;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    {</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;      <span class="keywordtype">double</span> tau = -1*table3gpp-&gt;m_rTau*DS*log (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue (0,1));         <span class="comment">//(7.5-1)</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;      <span class="keywordflow">if</span> (minTau &gt; tau)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        {</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;          minTau = tau;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        }</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      clusterDelay.push_back (tau);</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    }</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  channelParams-&gt;m_tauDelta = minTau;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    {</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      clusterDelay.at (cIndex) -= minTau;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    }</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;  std::sort (clusterDelay.begin (), clusterDelay.end ());       <span class="comment">//(7.5-2)</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;  <span class="comment">/* since the scaled Los delays are not to be used in cluster power generation,</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="comment">   * we will generate cluster power first and resume to compute Los cluster delay later.*/</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;  <span class="comment">//Step 6: Generate cluster powers.</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterPower;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;  <span class="keywordtype">double</span> powerSum = 0;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    {</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      <span class="keywordtype">double</span> power = exp (-1 * clusterDelay.at (cIndex) * (table3gpp-&gt;m_rTau - 1) / table3gpp-&gt;m_rTau / DS) *</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        pow (10,-1 * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * table3gpp-&gt;m_shadowingStd / 10);                       <span class="comment">//(7.5-5)</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;      powerSum += power;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;      clusterPower.push_back (power);</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    }</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  <span class="keywordtype">double</span> powerMax = 0;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    {</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;      clusterPower.at (cIndex) = clusterPower.at (cIndex) / powerSum;         <span class="comment">//(7.5-6)</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    }</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterPowerForAngles;       <span class="comment">// this power is only for equation (7.5-9) and (7.5-14), not for (7.5-22)</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    {</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;      <span class="keywordtype">double</span> K_linear = pow (10,K_factor / 10);</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        {</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;          <span class="keywordflow">if</span> (cIndex == 0)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;            {</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;              clusterPowerForAngles.push_back (clusterPower.at (cIndex) / (1 + K_linear) + K_linear / (1 + K_linear));                  <span class="comment">//(7.5-8)</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;            }</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;            {</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;              clusterPowerForAngles.push_back (clusterPower.at (cIndex) / (1 + K_linear));                  <span class="comment">//(7.5-8)</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;            }</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;          <span class="keywordflow">if</span> (powerMax &lt; clusterPowerForAngles.at (cIndex))</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;            {</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;              powerMax = clusterPowerForAngles.at (cIndex);</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            }</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        }</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    }</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    {</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numOfCluster; cIndex++)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        {</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;          clusterPowerForAngles.push_back (clusterPower.at (cIndex));              <span class="comment">//(7.5-6)</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;          <span class="keywordflow">if</span> (powerMax &lt; clusterPowerForAngles.at (cIndex))</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;            {</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;              powerMax = clusterPowerForAngles.at (cIndex);</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;            }</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        }</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    }</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <span class="comment">//remove clusters with less than -25 dB power compared to the maxim cluster power;</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="comment">//double thresh = pow(10,-2.5);</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordtype">double</span> thresh = 0.0032;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = numOfCluster; cIndex &gt; 0; cIndex--)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    {</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;      <span class="keywordflow">if</span> (clusterPowerForAngles.at (cIndex - 1) &lt; thresh * powerMax )</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        {</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;          clusterPowerForAngles.erase (clusterPowerForAngles.begin () + cIndex - 1);</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;          clusterPower.erase (clusterPower.begin () + cIndex - 1);</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;          clusterDelay.erase (clusterDelay.begin () + cIndex - 1);</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        }</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    }</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  uint8_t numReducedCluster = clusterPower.size ();</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  channelParams-&gt;m_numCluster = numReducedCluster;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  <span class="comment">// Resume step 5 to compute the delay for LoS condition.</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    {</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      <span class="keywordtype">double</span> C_tau = 0.7705 - 0.0433 * K_factor + 2e-4 * pow (K_factor,2) + 17e-6 * pow (K_factor,3);         <span class="comment">//(7.5-3)</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        {</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;          clusterDelay.at (cIndex) = clusterDelay.at (cIndex) / C_tau;             <span class="comment">//(7.5-4)</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        }</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    }</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <span class="comment">/*for (uint8_t i = 0; i &lt; clusterPowerForAngles.size(); i++)</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterPowerForAngles.at(i)&lt;&lt;&quot;s\t&quot;;</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;Delay:&quot;;</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterDelay.at(i)&lt;&lt;&quot;s\t&quot;;</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;Power:&quot;;</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterPower.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="comment">//step 7: Generate arrival and departure angles for both azimuth and elevation.</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="keywordtype">double</span> C_NLOS, C_phi;</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  <span class="comment">//According to table 7.5-6, only cluster number equals to 8, 10, 11, 12, 19 and 20 is valid.</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <span class="comment">//Not sure why the other cases are in Table 7.5-2.</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  <span class="keywordflow">switch</span> (numOfCluster)       <span class="comment">// Table 7.5-2</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    {</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <span class="keywordflow">case</span> 4:</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;      C_NLOS = 0.779;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">case</span> 5:</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;      C_NLOS = 0.860;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="keywordflow">case</span> 8:</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;      C_NLOS = 1.018;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;      C_NLOS = 1.090;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="keywordflow">case</span> 11:</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;      C_NLOS = 1.123;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="keywordflow">case</span> 12:</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;      C_NLOS = 1.146;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">case</span> 14:</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;      C_NLOS = 1.190;</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="keywordflow">case</span> 15:</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;      C_NLOS = 1.221;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">case</span> 16:</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;      C_NLOS = 1.226;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="keywordflow">case</span> 19:</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;      C_NLOS = 1.273;</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keywordflow">case</span> 20:</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      C_NLOS = 1.289;</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;      NS_FATAL_ERROR (<span class="stringliteral">&quot;Invalide cluster number&quot;</span>);</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    }</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    {</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;      C_phi = C_NLOS * (1.1035 - 0.028 * K_factor - 2e-3 * pow (K_factor,2) + 1e-4 * pow (K_factor,3));         <span class="comment">//(7.5-10))</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    }</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    {</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      C_phi = C_NLOS;           <span class="comment">//(7.5-10))</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    }</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="keywordtype">double</span> C_theta;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordflow">switch</span> (numOfCluster)       <span class="comment">//Table 7.5-4</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    {</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    <span class="keywordflow">case</span> 8:</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;      C_NLOS = 0.889;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;      C_NLOS = 0.957;</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">case</span> 11:</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;      C_NLOS = 1.031;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    <span class="keywordflow">case</span> 12:</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;      C_NLOS = 1.104;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="keywordflow">case</span> 19:</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;      C_NLOS = 1.184;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <span class="keywordflow">case</span> 20:</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;      C_NLOS = 1.178;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;      NS_FATAL_ERROR (<span class="stringliteral">&quot;Invalide cluster number&quot;</span>);</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    }</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    {</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;      C_theta = C_NLOS * (1.3086 + 0.0339 * K_factor - 0.0077 * pow (K_factor,2) + 2e-4 * pow (K_factor,3));         <span class="comment">//(7.5-15)</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    }</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    {</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;      C_theta = C_NLOS;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    }</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterAoa, clusterAod, clusterZoa, clusterZod;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;  <span class="keywordtype">double</span> angle;</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    {</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;      angle = 2*ASA*sqrt (-1 * log (clusterPowerForAngles.at (cIndex) / powerMax)) / 1.4 / C_phi;        <span class="comment">//(7.5-9)</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;      clusterAoa.push_back (angle);</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;      angle = 2*ASD*sqrt (-1 * log (clusterPowerForAngles.at (cIndex) / powerMax)) / 1.4 / C_phi;        <span class="comment">//(7.5-9)</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;      clusterAod.push_back (angle);</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;      angle = -1*ZSA*log (clusterPowerForAngles.at (cIndex) / powerMax) / C_theta;         <span class="comment">//(7.5-14)</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;      clusterZoa.push_back (angle);</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;      angle = -1*ZSD*log (clusterPowerForAngles.at (cIndex) / powerMax) / C_theta;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;      clusterZod.push_back (angle);</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    }</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    {</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="keywordtype">int</span> Xn = 1;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue (0,1) &lt; 0.5)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        {</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;          Xn = -1;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        }</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;      clusterAoa.at (cIndex) = clusterAoa.at (cIndex) * Xn + (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * ASA / 7) + rxAngle.phi * 180 / M_PI;        <span class="comment">//(7.5-11)</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      clusterAod.at (cIndex) = clusterAod.at (cIndex) * Xn + (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * ASD / 7) + txAngle.phi * 180 / M_PI;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      if (o2i)</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        {</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;          clusterZoa.at (cIndex) = clusterZoa.at (cIndex) * Xn + (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * ZSA / 7) + 90;            <span class="comment">//(7.5-16)</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        }</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        {</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;          clusterZoa.at (cIndex) = clusterZoa.at (cIndex) * Xn + (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * ZSA / 7) + rxAngle.theta * 180 / M_PI;            <span class="comment">//(7.5-16)</span></div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        }</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      clusterZod.at (cIndex) = clusterZod.at (cIndex) * Xn + (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * ZSD / 7) + txAngle.theta * 180 / M_PI + table3gpp-&gt;m_offsetZOD;        <span class="comment">//(7.5-19)</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    }</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    {</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;      <span class="comment">//The 7.5-12 can be rewrite as Theta_n,ZOA = Theta_n,ZOA - (Theta_1,ZOA - Theta_LOS,ZOA) = Theta_n,ZOA - diffZOA,</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;      <span class="comment">//Similar as AOD, ZSA and ZSD.</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;      <span class="keywordtype">double</span> diffAoa = clusterAoa.at (0) - rxAngle.phi * 180 / M_PI;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;      <span class="keywordtype">double</span> diffAod = clusterAod.at (0) - txAngle.phi * 180 / M_PI;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;      <span class="keywordtype">double</span> diffZsa = clusterZoa.at (0) - rxAngle.theta * 180 / M_PI;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;      <span class="keywordtype">double</span> diffZsd = clusterZod.at (0) - txAngle.theta * 180 / M_PI;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        {</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;          clusterAoa.at (cIndex) -= diffAoa;              <span class="comment">//(7.5-12)</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;          clusterAod.at (cIndex) -= diffAod;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;          clusterZoa.at (cIndex) -= diffZsa;              <span class="comment">//(7.5-17)</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;          clusterZod.at (cIndex) -= diffZsd;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        }</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    }</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordtype">double</span> rayAoa_radian[numReducedCluster][raysPerCluster];       <span class="comment">//rayAoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;  <span class="keywordtype">double</span> rayAod_radian[numReducedCluster][raysPerCluster];       <span class="comment">//rayAod_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  <span class="keywordtype">double</span> rayZoa_radian[numReducedCluster][raysPerCluster];       <span class="comment">//rayZoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="keywordtype">double</span> rayZod_radian[numReducedCluster][raysPerCluster];       <span class="comment">//rayZod_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="keywordflow">for</span> (uint8_t nInd = 0; nInd &lt; numReducedCluster; nInd++)</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    {</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <span class="keywordflow">for</span> (uint8_t mInd = 0; mInd &lt; raysPerCluster; mInd++)</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        {</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;          <span class="keywordtype">double</span> tempAoa = clusterAoa.at (nInd) + table3gpp-&gt;m_cASA * offSetAlpha[mInd];              <span class="comment">//(7.5-13)</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;          <span class="keywordflow">while</span> (tempAoa &gt; 360)</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            {</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;              tempAoa -= 360;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;            }</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;          <span class="keywordflow">while</span> (tempAoa &lt; 0)</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;            {</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;              tempAoa += 360;</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            }</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;          NS_ASSERT_MSG (tempAoa &gt;= 0 &amp;&amp; tempAoa &lt;= 360, <span class="stringliteral">&quot;the AOA should be the range of [0,360]&quot;</span>);</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;          rayAoa_radian[nInd][mInd] = tempAoa * M_PI / 180;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;          <span class="keywordtype">double</span> tempAod = clusterAod.at (nInd) + table3gpp-&gt;m_cASD * offSetAlpha[mInd];</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;          <span class="keywordflow">while</span> (tempAod &gt; 360)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;            {</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;              tempAod -= 360;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;            }</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;          <span class="keywordflow">while</span> (tempAod &lt; 0)</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            {</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;              tempAod += 360;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;            }</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;          NS_ASSERT_MSG (tempAod &gt;= 0 &amp;&amp; tempAod &lt;= 360, <span class="stringliteral">&quot;the AOD should be the range of [0,360]&quot;</span>);</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;          rayAod_radian[nInd][mInd] = tempAod * M_PI / 180;</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;          <span class="keywordtype">double</span> tempZoa = clusterZoa.at (nInd) + table3gpp-&gt;m_cZSA * offSetAlpha[mInd];              <span class="comment">//(7.5-18)</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;          <span class="keywordflow">while</span> (tempZoa &gt; 360)</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            {</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;              tempZoa -= 360;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            }</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;          <span class="keywordflow">while</span> (tempZoa &lt; 0)</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            {</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;              tempZoa += 360;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            }</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;          <span class="keywordflow">if</span> (tempZoa &gt; 180)</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            {</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;              tempZoa = 360 - tempZoa;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;            }</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;          NS_ASSERT_MSG (tempZoa &gt;= 0&amp;&amp;tempZoa &lt;= 180, <span class="stringliteral">&quot;the ZOA should be the range of [0,180]&quot;</span>);</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;          rayZoa_radian[nInd][mInd] = tempZoa * M_PI / 180;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;          <span class="keywordtype">double</span> tempZod = clusterZod.at (nInd) + 0.375 * pow (10,table3gpp-&gt;m_uLgZSD) * offSetAlpha[mInd];             <span class="comment">//(7.5-20)</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;          <span class="keywordflow">while</span> (tempZod &gt; 360)</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            {</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;              tempZod -= 360;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            }</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;          <span class="keywordflow">while</span> (tempZod &lt; 0)</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;            {</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;              tempZod += 360;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            }</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;          <span class="keywordflow">if</span> (tempZod &gt; 180)</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            {</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;              tempZod = 360 - tempZod;</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;            }</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;          NS_ASSERT_MSG (tempZod &gt;= 0&amp;&amp;tempZod &lt;= 180, <span class="stringliteral">&quot;the ZOD should be the range of [0,180]&quot;</span>);</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;          rayZod_radian[nInd][mInd] = tempZod * M_PI / 180;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        }</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    }</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> angle_degree;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;  <span class="keywordtype">double</span> sizeTemp = clusterZoa.size ();</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;  <span class="keywordflow">for</span> (uint8_t ind = 0; ind &lt; 4; ind++)</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    {</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;      <span class="keywordflow">switch</span> (ind)</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <span class="keywordflow">case</span> 0:</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;          angle_degree = clusterAoa;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;          angle_degree = clusterZoa;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;          angle_degree = clusterAod;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;          angle_degree = clusterZod;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;          NS_FATAL_ERROR (<span class="stringliteral">&quot;Programming Error&quot;</span>);</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        }</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;      <span class="keywordflow">for</span> (uint8_t nIndex = 0; nIndex &lt; sizeTemp; nIndex++)</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        {</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;          <span class="keywordflow">while</span> (angle_degree[nIndex] &gt; 360)</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;            {</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;              angle_degree[nIndex] -= 360;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;            }</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;          <span class="keywordflow">while</span> (angle_degree[nIndex] &lt; 0)</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;            {</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;              angle_degree[nIndex] += 360;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;            }</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;          <span class="keywordflow">if</span> (ind == 1 || ind == 3)</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;            {</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;              <span class="keywordflow">if</span> (angle_degree[nIndex] &gt; 180)</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                  angle_degree[nIndex] = 360 - angle_degree[nIndex];</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;                }</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;            }</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        }</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;      <span class="keywordflow">switch</span> (ind)</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        {</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        <span class="keywordflow">case</span> 0:</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;          clusterAoa = angle_degree;</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;          clusterZoa = angle_degree;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;          clusterAod = angle_degree;</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;          clusterZod = angle_degree;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;          NS_FATAL_ERROR (<span class="stringliteral">&quot;Programming Error&quot;</span>);</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        }</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    }</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> attenuation_dB;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a576e8ac3fb04ac54bde5f903058e2295">m_blockage</a>)</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    {</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      attenuation_dB = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac41e36c24b741639642e9bcae35ef9c2">CalAttenuationOfBlockage</a> (channelParams, clusterAoa, clusterZoa);</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;      <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; numReducedCluster; cInd++)</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;        {</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;          clusterPower.at (cInd) = clusterPower.at (cInd) / pow (10,attenuation_dB.at (cInd) / 10);</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        }</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    }</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    {</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;      attenuation_dB.push_back (0);</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    }</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;BlockedPower:&quot;;</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterPower.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;AOD:&quot;;</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterAod.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;AOA:&quot;;</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterAoa.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;ZOD:&quot;;</span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterZod.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">          for (uint8_t d = 0; d &lt; raysPerCluster; d++)</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">          {</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">                  std::cout &lt;&lt;rayZod_radian[i][d]&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="comment">          }</span></div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="comment">          std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;ZOA:&quot;;</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; numReducedCluster; i++)</span></div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterZoa.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;  <span class="comment">//Step 8: Coupling of rays within a cluster for both azimuth and elevation</span></div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="comment">//shuffle all the arrays to perform random coupling</span></div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    {</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;      std::shuffle (&amp;rayAod_radian[cIndex][0],&amp;rayAod_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 100));</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;      std::shuffle (&amp;rayAoa_radian[cIndex][0],&amp;rayAoa_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 200));</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;      std::shuffle (&amp;rayZod_radian[cIndex][0],&amp;rayZod_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 300));</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      std::shuffle (&amp;rayZoa_radian[cIndex][0],&amp;rayZoa_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 400));</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    }</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  <span class="comment">//Step 9: Generate the cross polarization power ratios</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="comment">//This step is skipped, only vertical polarization is considered in this version</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <span class="comment">//Step 10: Draw initial phases</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#ab0854bed411e4946154bde1bc58dfc2e">double2DVector_t</a> clusterPhase;       <span class="comment">//rayAoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;  <span class="keywordflow">for</span> (uint8_t nInd = 0; nInd &lt; numReducedCluster; nInd++)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    {</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;      <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> temp;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      <span class="keywordflow">for</span> (uint8_t mInd = 0; mInd &lt; raysPerCluster; mInd++)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        {</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;          temp.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue (-1 * M_PI, M_PI));</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;        }</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;      clusterPhase.push_back (temp);</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    }</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;  <span class="keywordtype">double</span> losPhase = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">m_uniformRv</a>-&gt;GetValue (-1 * M_PI, M_PI);</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  channelParams-&gt;m_clusterPhase = clusterPhase;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  channelParams-&gt;m_losPhase = losPhase;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  <span class="comment">//Step 11: Generate channel coefficients for each cluster n and each receiver and transmitter element pair u,s.</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af35fc24df93c81f80f9a15773258fc20">complex3DVector_t</a> H_NLOS;       <span class="comment">// channel coefficients H_NLOS [u][s][n],</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;  <span class="comment">// where u and s are receive and transmit antenna element, n is cluster index.</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  uint64_t uSize = rxAntennaNum[0] * rxAntennaNum[1];</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;  uint64_t sSize = txAntennaNum[0] * txAntennaNum[1];</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  uint8_t cluster1st = 0, cluster2nd = 0;       <span class="comment">// first and second strongest cluster;</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  <span class="keywordtype">double</span> maxPower = 0;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    {</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;      <span class="keywordflow">if</span> (maxPower &lt; clusterPower.at (cIndex))</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        {</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;          maxPower = clusterPower.at (cIndex);</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;          cluster1st = cIndex;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        }</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    }</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  maxPower = 0;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; numReducedCluster; cIndex++)</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    {</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;      <span class="keywordflow">if</span> (maxPower &lt; clusterPower.at (cIndex) &amp;&amp; cluster1st != cIndex)</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        {</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;          maxPower = clusterPower.at (cIndex);</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;          cluster2nd = cIndex;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        }</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    }</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;1st strongest cluster:&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cluster1st &lt;&lt; <span class="stringliteral">&quot;, 2nd strongest cluster:&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cluster2nd);</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af35fc24df93c81f80f9a15773258fc20">complex3DVector_t</a> H_usn;       <span class="comment">//channel coffecient H_usn[u][s][n];</span></div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  <span class="comment">//Since each of the strongest 2 clusters are divided into 3 sub-clusters, the total cluster will be numReducedCLuster + 4.</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  H_usn.resize (uSize);</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;  <span class="keywordflow">for</span> (uint64_t uIndex = 0; uIndex &lt; uSize; uIndex++)</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    {</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;      H_usn.at (uIndex).resize (sSize);</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;      <span class="keywordflow">for</span> (uint64_t sIndex = 0; sIndex &lt; sSize; sIndex++)</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        {</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;          H_usn.at (uIndex).at (sIndex).resize (numReducedCluster);</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        }</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    }</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="comment">//double slotTime = Simulator::Now ().GetSeconds ();</span></div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="comment">// The following for loops computes the channel coefficients</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  <span class="keywordflow">for</span> (uint64_t uIndex = 0; uIndex &lt; uSize; uIndex++)</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    {</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;      Vector uLoc = rxAntenna-&gt;GetAntennaLocation (uIndex,rxAntennaNum);</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;      <span class="keywordflow">for</span> (uint64_t sIndex = 0; sIndex &lt; sSize; sIndex++)</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        {</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;          Vector sLoc = txAntenna-&gt;GetAntennaLocation (sIndex,txAntennaNum);</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;          <span class="keywordflow">for</span> (uint8_t nIndex = 0; nIndex &lt; numReducedCluster; nIndex++)</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            {</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;              <span class="comment">//Compute the N-2 weakest cluster, only vertical polarization. (7.5-22)</span></div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;              <span class="keywordflow">if</span> (nIndex != cluster1st &amp;&amp; nIndex != cluster2nd)</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                {</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                  std::complex&lt;double&gt; rays (0,0);</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                  <span class="keywordflow">for</span> (uint8_t mIndex = 0; mIndex &lt; raysPerCluster; mIndex++)</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                    {</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                      <span class="keywordtype">double</span> initialPhase = clusterPhase.at (nIndex).at (mIndex);</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                      <span class="comment">//lambda_0 is accounted in the antenna spacing uLoc and sLoc.</span></div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                      <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rayZoa_radian[nIndex][mIndex]) * cos (rayAoa_radian[nIndex][mIndex]) * uLoc.x</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                                                       + sin (rayZoa_radian[nIndex][mIndex]) * sin (rayAoa_radian[nIndex][mIndex]) * uLoc.y</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                                                       + cos (rayZoa_radian[nIndex][mIndex]) * uLoc.z);</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;                      <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (rayZod_radian[nIndex][mIndex]) * cos (rayAod_radian[nIndex][mIndex]) * sLoc.x</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                                                       + sin (rayZod_radian[nIndex][mIndex]) * sin (rayAod_radian[nIndex][mIndex]) * sLoc.y</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                                                       + cos (rayZod_radian[nIndex][mIndex]) * sLoc.z);</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                      <span class="comment">//Doppler is computed in the CalBeamformingGain function and is simplified to only account for the center anngle of each cluster.</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                      <span class="comment">//double doppler = 2*M_PI*(sin(rayZoa_radian[nIndex][mIndex])*cos(rayAoa_radian[nIndex][mIndex])*relativeSpeed.x</span></div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                      <span class="comment">//        + sin(rayZoa_radian[nIndex][mIndex])*sin(rayAoa_radian[nIndex][mIndex])*relativeSpeed.y</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                      <span class="comment">//        + cos(rayZoa_radian[nIndex][mIndex])*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                      rays += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                        * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                           * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                        * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;                        * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                      <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;                      <span class="comment">//rays += 1;</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;                    }</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;                  <span class="comment">//rays *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                  rays *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) = rays;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                }</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;              <span class="keywordflow">else</span>                   <span class="comment">//(7.5-28)</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                {</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;                  std::complex&lt;double&gt; raysSub1 (0,0);</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;                  std::complex&lt;double&gt; raysSub2 (0,0);</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;                  std::complex&lt;double&gt; raysSub3 (0,0);</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;                  <span class="keywordflow">for</span> (uint8_t mIndex = 0; mIndex &lt; raysPerCluster; mIndex++)</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;                    {</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                      <span class="comment">//ZML:Just remind me that the angle offsets for the 3 subclusters were not generated correctly.</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                      <span class="keywordtype">double</span> initialPhase = clusterPhase.at (nIndex).at (mIndex);</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                      <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rayZoa_radian[nIndex][mIndex]) * cos (rayAoa_radian[nIndex][mIndex]) * uLoc.x</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                                                       + sin (rayZoa_radian[nIndex][mIndex]) * sin (rayAoa_radian[nIndex][mIndex]) * uLoc.y</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;                                                       + cos (rayZoa_radian[nIndex][mIndex]) * uLoc.z);</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;                      <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (rayZod_radian[nIndex][mIndex]) * cos (rayAod_radian[nIndex][mIndex]) * sLoc.x</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;                                                       + sin (rayZod_radian[nIndex][mIndex]) * sin (rayAod_radian[nIndex][mIndex]) * sLoc.y</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                                                       + cos (rayZod_radian[nIndex][mIndex]) * sLoc.z);</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                      <span class="comment">//double doppler = 2*M_PI*(sin(rayZoa_radian[nIndex][mIndex])*cos(rayAoa_radian[nIndex][mIndex])*relativeSpeed.x</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;                      <span class="comment">//        + sin(rayZoa_radian[nIndex][mIndex])*sin(rayAoa_radian[nIndex][mIndex])*relativeSpeed.y</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;                      <span class="comment">//        + cos(rayZoa_radian[nIndex][mIndex])*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                      <span class="comment">//double delaySpread;</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                      <span class="keywordflow">switch</span> (mIndex)</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;                        {</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                        <span class="keywordflow">case</span> 9:</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                        <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                        <span class="keywordflow">case</span> 11:</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                        <span class="keywordflow">case</span> 12:</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                        <span class="keywordflow">case</span> 17:</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                        <span class="keywordflow">case</span> 18:</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                          <span class="comment">//delaySpread= -2*M_PI*(clusterDelay.at(nIndex)+1.28*c_DS)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                          raysSub2 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                          <span class="comment">//raysSub2 +=1;</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                        <span class="keywordflow">case</span> 13:</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                        <span class="keywordflow">case</span> 14:</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                        <span class="keywordflow">case</span> 15:</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                        <span class="keywordflow">case</span> 16:</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                          <span class="comment">//delaySpread = -2*M_PI*(clusterDelay.at(nIndex)+2.56*c_DS)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                          raysSub3 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                          <span class="comment">//raysSub3 +=1;</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                        <span class="keywordflow">default</span>:                        <span class="comment">//case 1,2,3,4,5,6,7,8,19,20</span></div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                                                        <span class="comment">//delaySpread = -2*M_PI*clusterDelay.at(nIndex)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                          raysSub1 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                          <span class="comment">//raysSub1 +=1;</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                        }</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                    }</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                  <span class="comment">//raysSub1 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;                  <span class="comment">//raysSub2 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;                  <span class="comment">//raysSub3 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                  raysSub1 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                  raysSub2 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                  raysSub3 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) = raysSub1;</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                  H_usn.at (uIndex).at (sIndex).push_back (raysSub2);</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                  H_usn.at (uIndex).at (sIndex).push_back (raysSub3);</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                }</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;            }</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;          <span class="keywordflow">if</span> (condition == <span class="charliteral">&#39;l&#39;</span>)               <span class="comment">//(7.5-29) &amp;&amp; (7.5-30)</span></div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            {</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;              std::complex&lt;double&gt; ray (0,0);</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;              <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rxAngle.theta) * cos (rxAngle.phi) * uLoc.x</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                                               + sin (rxAngle.theta) * sin (rxAngle.phi) * uLoc.y</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;                                               + cos (rxAngle.theta) * uLoc.z);</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;              <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (txAngle.theta) * cos (txAngle.phi) * sLoc.x</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                                               + sin (txAngle.theta) * sin (txAngle.phi) * sLoc.y</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                                               + cos (txAngle.theta) * sLoc.z);</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;              <span class="comment">//double doppler = 2*M_PI*(sin(rxAngle.theta)*cos(rxAngle.phi)*relativeSpeed.x</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;              <span class="comment">//        + sin(rxAngle.theta)*sin(rxAngle.phi)*relativeSpeed.y</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;              <span class="comment">//        + cos(rxAngle.theta)*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;              ray = exp (std::complex&lt;double&gt; (0, losPhase))</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                * (rxAntenna-&gt;GetRadiationPattern (rxAngle.theta,rxAngle.phi)</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                   * txAntenna-&gt;GetRadiationPattern (txAngle.theta,rxAngle.phi))</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;                * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;              <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;              <span class="keywordtype">double</span> K_linear = pow (10,K_factor / 10);</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;              <span class="comment">// the LOS path should be attenuated if blockage is enabled.</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;              H_usn.at (uIndex).at (sIndex).at (0) = sqrt (1 / (K_linear + 1)) * H_usn.at (uIndex).at (sIndex).at (0) + sqrt (K_linear / (1 + K_linear)) * ray / pow (10,attenuation_dB.at (0) / 10);           <span class="comment">//(7.5-30) for tau = tau1</span></div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;              <span class="keywordtype">double</span> tempSize = H_usn.at (uIndex).at (sIndex).size ();</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;              <span class="keywordflow">for</span> (uint8_t nIndex = 1; nIndex &lt; tempSize; nIndex++)</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                {</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) *= sqrt (1 / (K_linear + 1));                   <span class="comment">//(7.5-30) for tau = tau2...taunN</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;                }</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;            }</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        }</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    }</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  <span class="keywordflow">if</span> (cluster1st == cluster2nd)</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    {</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;      clusterDelay.push_back (clusterDelay.at (cluster1st) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      clusterDelay.push_back (clusterDelay.at (cluster1st) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;      clusterAoa.push_back (clusterAoa.at (cluster1st));</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;      clusterAoa.push_back (clusterAoa.at (cluster1st));</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;      clusterZoa.push_back (clusterZoa.at (cluster1st));</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;      clusterZoa.push_back (clusterZoa.at (cluster1st));</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      clusterAod.push_back (clusterAod.at (cluster1st));</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;      clusterAod.push_back (clusterAod.at (cluster1st));</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;      clusterZod.push_back (clusterZod.at (cluster1st));</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;      clusterZod.push_back (clusterZod.at (cluster1st));</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    }</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    {</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;      <span class="keywordtype">double</span> min, max;</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      <span class="keywordflow">if</span> (cluster1st &lt; cluster2nd)</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        {</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;          min = cluster1st;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;          max = cluster2nd;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;        }</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        {</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;          min = cluster2nd;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;          max = cluster1st;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        }</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;      clusterDelay.push_back (clusterDelay.at (min) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;      clusterDelay.push_back (clusterDelay.at (min) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;      clusterDelay.push_back (clusterDelay.at (max) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;      clusterDelay.push_back (clusterDelay.at (max) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;      clusterAoa.push_back (clusterAoa.at (min));</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;      clusterAoa.push_back (clusterAoa.at (min));</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;      clusterAoa.push_back (clusterAoa.at (max));</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;      clusterAoa.push_back (clusterAoa.at (max));</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;      clusterZoa.push_back (clusterZoa.at (min));</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;      clusterZoa.push_back (clusterZoa.at (min));</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;      clusterZoa.push_back (clusterZoa.at (max));</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;      clusterZoa.push_back (clusterZoa.at (max));</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;      clusterAod.push_back (clusterAod.at (min));</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;      clusterAod.push_back (clusterAod.at (min));</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;      clusterAod.push_back (clusterAod.at (max));</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;      clusterAod.push_back (clusterAod.at (max));</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;      clusterZod.push_back (clusterZod.at (min));</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;      clusterZod.push_back (clusterZod.at (min));</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;      clusterZod.push_back (clusterZod.at (max));</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;      clusterZod.push_back (clusterZod.at (max));</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    }</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;size of coefficient matrix =[&quot;</span> &lt;&lt; H_usn.size () &lt;&lt; <span class="stringliteral">&quot;][&quot;</span> &lt;&lt; H_usn.at (0).size () &lt;&lt; <span class="stringliteral">&quot;][&quot;</span> &lt;&lt; H_usn.at (0).at (0).size () &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;Delay:&quot;;</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; clusterDelay.size(); i++)</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterDelay.at(i)&lt;&lt;&quot;s\t&quot;;</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;  channelParams-&gt;m_channel = H_usn;</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  channelParams-&gt;m_delay = clusterDelay;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;  channelParams-&gt;m_angle.clear ();</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;  channelParams-&gt;m_angle.push_back (clusterAoa);</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;  channelParams-&gt;m_angle.push_back (clusterZoa);</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;  channelParams-&gt;m_angle.push_back (clusterAod);</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;  channelParams-&gt;m_angle.push_back (clusterZod);</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;  <span class="keywordflow">return</span> channelParams;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;}</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;Ptr&lt;Params3gpp&gt;</div><div class="line"><a name="l01632"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaddcd856c8a98280eea9b628315a5f87"> 1632</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaddcd856c8a98280eea9b628315a5f87">MmWaveVehicularSpectrumPropagationLossModel::UpdateChannel</a> (Ptr&lt;Params3gpp&gt; params3gpp, Ptr&lt;ParamsTable&gt;  table3gpp,</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                                  Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; txAntenna, Ptr&lt;MmWaveVehicularAntennaArrayModel&gt; rxAntenna,</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                                  uint16_t *txAntennaNum, uint16_t *rxAntennaNum, Angles &amp;rxAngle, Angles &amp;txAngle)<span class="keyword"> const</span></div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;  Ptr&lt;Params3gpp&gt; params = params3gpp;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;  uint8_t raysPerCluster = table3gpp-&gt;m_raysPerCluster;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;  <span class="comment">//We first update the current location, the previous location will be updated in the end.</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;  <span class="comment">//Step 4: Get LSP from previous channel</span></div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;  <span class="keywordtype">double</span> DS = params-&gt;m_DS;</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;  <span class="keywordtype">double</span> K_factor = params-&gt;m_K;</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;  <span class="comment">//Step 5: Update Delays.</span></div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;  <span class="comment">//copy delay from previous channel.</span></div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterDelay;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;  <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; params-&gt;m_numCluster; cInd++)</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;    {</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;      clusterDelay.push_back (params-&gt;m_delay.at (cInd));</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    }</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;  <span class="comment">//If LOS condition, we need to revert the tau^LOS_n back to tau_n.</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;  <span class="keywordflow">if</span> (params-&gt;m_condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    {</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;      <span class="keywordtype">double</span> C_tau = 0.7705 - 0.0433 * K_factor + 2e-4 * pow (K_factor,2) + 17e-6 * pow (K_factor,3);         <span class="comment">//(7.5-3)</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        {</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;          clusterDelay.at (cIndex) = clusterDelay.at (cIndex) * C_tau;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        }</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    }</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="comment">//update delay based on equation (7.6-9)</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    {</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;      clusterDelay.at (cIndex) -= (sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex) * M_PI / 180) * cos (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>).at (cIndex) * M_PI / 180) * params-&gt;m_speed.x</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                                   + sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex) * M_PI / 180) * sin (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>).at (cIndex) * M_PI / 180) * params-&gt;m_speed.y) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">m_updatePeriod</a>.GetSeconds () / 3e8; <span class="comment">//(7.6-9)</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    }</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;  <span class="comment">/* since the scaled Los delays are not to be used in cluster power generation,</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="comment">   * we will generate cluster power first and resume to compute Los cluster delay later.*/</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;  <span class="comment">//Step 6: Generate cluster powers.</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterPower;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;  <span class="keywordtype">double</span> powerSum = 0;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;    {</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;      <span class="keywordtype">double</span> power = exp (-1 * clusterDelay.at (cIndex) * (table3gpp-&gt;m_rTau - 1) / table3gpp-&gt;m_rTau / DS) *</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        pow (10,-1 * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue () * table3gpp-&gt;m_shadowingStd / 10);                       <span class="comment">//(7.5-5)</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;      powerSum += power;</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;      clusterPower.push_back (power);</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    }</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;  <span class="comment">// we do not need to compute the cluster power of LOS case, since it is used for generating angles.</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    {</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;      clusterPower.at (cIndex) = clusterPower.at (cIndex) / powerSum;         <span class="comment">//(7.5-6)</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;    }</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;  <span class="comment">// Resume step 5 to compute the delay for LoS condition.</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;  <span class="keywordflow">if</span> (params-&gt;m_condition == <span class="charliteral">&#39;l&#39;</span>)</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    {</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;      <span class="keywordtype">double</span> C_tau = 0.7705 - 0.0433 * K_factor + 2e-4 * pow (K_factor,2) + 17e-6 * pow (K_factor,3);         <span class="comment">//(7.5-3)</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;      <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        {</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;          clusterDelay.at (cIndex) = clusterDelay.at (cIndex) / C_tau;             <span class="comment">//(7.5-4)</span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        }</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;    }</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;Delay:&quot;;</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterDelay.at(i)&lt;&lt;&quot;s\t&quot;;</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;Power:&quot;;</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterPower.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;  <span class="comment">//step 7: Generate arrival and departure angles for both azimuth and elevation.</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="comment">//copy the angles from previous channel</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterAoa, clusterZoa, clusterAod, clusterZod;</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;  <span class="comment">/*</span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="comment">   * copy the angles from previous channel</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="comment">   * need to change the angle according to equations (7.6-11) - (7.6-14)*/</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    {</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;      clusterAoa.push_back (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>).at (cIndex));</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;      clusterZoa.push_back (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>).at (cIndex));</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;      clusterAod.push_back (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>).at (cIndex));</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      clusterZod.push_back (params-&gt;m_angle.at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>).at (cIndex));</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    }</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;  <span class="keywordtype">double</span> v = sqrt (params-&gt;m_speed.x * params-&gt;m_speed.x + params-&gt;m_speed.y * params-&gt;m_speed.y);</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;  <span class="keywordflow">if</span> (v &gt; 1e-6)      <span class="comment">//Update the angles only when the speed is not 0.</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    {</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;      <span class="keywordflow">if</span> (params-&gt;m_norRvAngles.size () == 0)</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;        {</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;          <span class="comment">//initial case</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;          <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; params-&gt;m_numCluster; cInd++)</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;            {</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;              <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> temp;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;              temp.push_back (0);                  <span class="comment">//initial random angle for AOA</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;              temp.push_back (0);                  <span class="comment">//initial random angle for ZOA</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;              temp.push_back (0);                  <span class="comment">//initial random angle for AOD</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;              temp.push_back (0);                  <span class="comment">//initial random angle for ZOD</span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;              params-&gt;m_norRvAngles.push_back (temp);</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;            }</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;        }</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;      <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; params-&gt;m_numCluster; cInd++)</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;        {</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;          <span class="keywordtype">double</span>  timeDiff = Now ().GetSeconds () - params-&gt;m_generatedTime.GetSeconds ();</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;          <span class="keywordtype">double</span> ranPhiAOD, ranThetaZOD, ranPhiAOA, ranThetaZOA;</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;          <span class="keywordflow">if</span> (params-&gt;m_condition == <span class="charliteral">&#39;l&#39;</span> &amp;&amp; cInd == 0)              <span class="comment">//These angles equal 0 for LOS path.</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;            {</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;              ranPhiAOD = 0;</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;              ranThetaZOD = 0;</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;              ranPhiAOA = 0;</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;              ranThetaZOA = 0;</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;            }</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;            {</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;              <span class="keywordtype">double</span> deltaX = sqrt (pow (params-&gt;m_preLocUT.x - params-&gt;m_locUT.x, 2) + pow (params-&gt;m_preLocUT.y - params-&gt;m_locUT.y, 2));</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;              <span class="keywordtype">double</span> R_phi = exp (-1 * deltaX / 50);                  <span class="comment">// 50 m is the correlation distance as specified in TR 38.900 Sec 7.6.3.2</span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;              <span class="keywordtype">double</span> R_theta = exp (-1 * deltaX / 100);                  <span class="comment">// 100 m is the correlation distance as specified in TR 38.900 Sec 7.6.3.2</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;              <span class="comment">//In order to generate correlated uniform random variables, we first generate correlated normal random variables and map the normal RV to uniform RV.</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;              <span class="comment">//Notice the correlation will change if the RV is transformed from normal to uniform.</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;              <span class="comment">//To compensate the distortion, the correlation of the normal RV is computed</span></div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;              <span class="comment">//such that the uniform RV would have the desired correlation when transformed from normal RV.</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;              <span class="comment">//The following formula was obtained from MATLAB numerical simulation.</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;              <span class="keywordflow">if</span> (R_phi * R_phi * (-0.069) + R_phi * 1.074 - 0.002 &lt; 1)                  <span class="comment">//When the correlation for normal RV is close to 1, no need to transform.</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;                {</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;                  R_phi = R_phi * R_phi * (-0.069) + R_phi * 1.074 - 0.002;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;                }</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;              <span class="keywordflow">if</span> (R_theta * R_theta * (-0.069) + R_theta * 1.074 - 0.002 &lt; 1)</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;                {</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;                  R_theta = R_theta * R_theta * (-0.069) + R_theta * 1.074 - 0.002;</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;                }</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;              <span class="comment">//We can generate a new correlated normal RV with the following formula</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;              params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>) = R_phi * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>) + sqrt (1 - R_phi * R_phi) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue ();</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;              params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>) = R_theta * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>) + sqrt (1 - R_theta * R_theta) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue ();</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;              params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>) = R_phi * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>) + sqrt (1 - R_phi * R_phi) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue ();</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;              params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>) = R_theta * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>) + sqrt (1 - R_theta * R_theta) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">m_normalRv</a>-&gt;GetValue ();</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;              <span class="comment">//The normal RV is transformed to uniform RV with the desired correlation.</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;              ranPhiAOD = (0.5 * erfc (-1 * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a>) / sqrt (2))) * 2 * M_PI - M_PI;</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;              ranThetaZOD = (0.5 * erfc (-1 * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a>) / sqrt (2))) * M_PI - 0.5 * M_PI;</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;              ranPhiAOA = (0.5 * erfc (-1 * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a>) / sqrt (2))) * 2 * M_PI - M_PI;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;              ranThetaZOA = (0.5 * erfc (-1 * params-&gt;m_norRvAngles.at (cInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a>) / sqrt (2))) * M_PI - 0.5 * M_PI;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;            }</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;          clusterAod.at (cInd) += v * timeDiff *</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;            sin (atan (params-&gt;m_speed.y / params-&gt;m_speed.x) - clusterAod.at (cInd) * M_PI / 180 + ranPhiAOD) * 180 / (M_PI * params-&gt;m_dis2D);</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;          clusterZod.at (cInd) -= v * timeDiff *</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;            cos (atan (params-&gt;m_speed.y / params-&gt;m_speed.x) - clusterAod.at (cInd) * M_PI / 180 + ranThetaZOD) * 180 / (M_PI * params-&gt;m_dis3D);</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;          clusterAoa.at (cInd) -= v * timeDiff *</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;            sin (atan (params-&gt;m_speed.y / params-&gt;m_speed.x) - clusterAoa.at (cInd) * M_PI / 180 + ranPhiAOA) * 180 / (M_PI * params-&gt;m_dis2D);</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;          clusterZoa.at (cInd) -= v * timeDiff *</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;            cos (atan (params-&gt;m_speed.y / params-&gt;m_speed.x) - clusterAoa.at (cInd) * M_PI / 180 + ranThetaZOA) * 180 / (M_PI * params-&gt;m_dis3D);</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;        }</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    }</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;  <span class="keywordtype">double</span> rayAoa_radian[params-&gt;m_numCluster][raysPerCluster];       <span class="comment">//rayAoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;  <span class="keywordtype">double</span> rayAod_radian[params-&gt;m_numCluster][raysPerCluster];       <span class="comment">//rayAod_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;  <span class="keywordtype">double</span> rayZoa_radian[params-&gt;m_numCluster][raysPerCluster];       <span class="comment">//rayZoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;  <span class="keywordtype">double</span> rayZod_radian[params-&gt;m_numCluster][raysPerCluster];       <span class="comment">//rayZod_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;  <span class="keywordflow">for</span> (uint8_t nInd = 0; nInd &lt; params-&gt;m_numCluster; nInd++)</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    {</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;      <span class="keywordflow">for</span> (uint8_t mInd = 0; mInd &lt; raysPerCluster; mInd++)</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;        {</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;          <span class="keywordtype">double</span> tempAoa = clusterAoa.at (nInd) + table3gpp-&gt;m_cASA * offSetAlpha[mInd];              <span class="comment">//(7.5-13)</span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;          <span class="keywordflow">while</span> (tempAoa &gt; 360)</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;            {</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;              tempAoa -= 360;</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;            }</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;          <span class="keywordflow">while</span> (tempAoa &lt; 0)</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;            {</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;              tempAoa += 360;</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;            }</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;          NS_ASSERT_MSG (tempAoa &gt;= 0 &amp;&amp; tempAoa &lt;= 360, <span class="stringliteral">&quot;the AOA should be the range of [0,360]&quot;</span>);</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;          rayAoa_radian[nInd][mInd] = tempAoa * M_PI / 180;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;          <span class="keywordtype">double</span> tempAod = clusterAod.at (nInd) + table3gpp-&gt;m_cASD * offSetAlpha[mInd];</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;          <span class="keywordflow">while</span> (tempAod &gt; 360)</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;            {</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;              tempAod -= 360;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;            }</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;          <span class="keywordflow">while</span> (tempAod &lt; 0)</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;            {</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;              tempAod += 360;</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;            }</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;          NS_ASSERT_MSG (tempAod &gt;= 0 &amp;&amp; tempAod &lt;= 360, <span class="stringliteral">&quot;the AOD should be the range of [0,360]&quot;</span>);</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;          rayAod_radian[nInd][mInd] = tempAod * M_PI / 180;</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;          <span class="keywordtype">double</span> tempZoa = clusterZoa.at (nInd) + table3gpp-&gt;m_cZSA * offSetAlpha[mInd];              <span class="comment">//(7.5-18)</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;          <span class="keywordflow">while</span> (tempZoa &gt; 360)</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;            {</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;              tempZoa -= 360;</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;            }</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;          <span class="keywordflow">while</span> (tempZoa &lt; 0)</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;            {</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;              tempZoa += 360;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;            }</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;          <span class="keywordflow">if</span> (tempZoa &gt; 180)</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;            {</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;              tempZoa = 360 - tempZoa;</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;            }</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;          NS_ASSERT_MSG (tempZoa &gt;= 0&amp;&amp;tempZoa &lt;= 180, <span class="stringliteral">&quot;the ZOA should be the range of [0,180]&quot;</span>);</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;          rayZoa_radian[nInd][mInd] = tempZoa * M_PI / 180;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;          <span class="keywordtype">double</span> tempZod = clusterZod.at (nInd) + 0.375 * pow (10,table3gpp-&gt;m_uLgZSD) * offSetAlpha[mInd];             <span class="comment">//(7.5-20)</span></div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;          <span class="keywordflow">while</span> (tempZod &gt; 360)</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;            {</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;              tempZod -= 360;</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;            }</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;          <span class="keywordflow">while</span> (tempZod &lt; 0)</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;            {</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;              tempZod += 360;</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;            }</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;          <span class="keywordflow">if</span> (tempZod &gt; 180)</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            {</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;              tempZod = 360 - tempZod;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;            }</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;          NS_ASSERT_MSG (tempZod &gt;= 0&amp;&amp;tempZod &lt;= 180, <span class="stringliteral">&quot;the ZOD should be the range of [0,180]&quot;</span>);</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;          rayZod_radian[nInd][mInd] = tempZod * M_PI / 180;</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        }</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    }</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> angle_degree;</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;  <span class="keywordtype">double</span> sizeTemp = clusterZoa.size ();</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;  <span class="keywordflow">for</span> (uint8_t ind = 0; ind &lt; 4; ind++)</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    {</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;      <span class="keywordflow">switch</span> (ind)</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;        {</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;        <span class="keywordflow">case</span> 0:</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;          angle_degree = clusterAoa;</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;          angle_degree = clusterZoa;</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;          angle_degree = clusterAod;</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;          angle_degree = clusterZod;</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;          NS_FATAL_ERROR (<span class="stringliteral">&quot;Programming Error&quot;</span>);</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        }</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;      <span class="keywordflow">for</span> (uint8_t nIndex = 0; nIndex &lt; sizeTemp; nIndex++)</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;        {</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;          <span class="keywordflow">while</span> (angle_degree[nIndex] &gt; 360)</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;            {</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;              angle_degree[nIndex] -= 360;</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;            }</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;          <span class="keywordflow">while</span> (angle_degree[nIndex] &lt; 0)</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;            {</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;              angle_degree[nIndex] += 360;</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;            }</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;          <span class="keywordflow">if</span> (ind == 1 || ind == 3)</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;            {</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;              <span class="keywordflow">if</span> (angle_degree[nIndex] &gt; 180)</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;                {</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;                  angle_degree[nIndex] = 360 - angle_degree[nIndex];</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                }</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;            }</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        }</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;      <span class="keywordflow">switch</span> (ind)</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        {</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;        <span class="keywordflow">case</span> 0:</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;          clusterAoa = angle_degree;</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;        <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;          clusterZoa = angle_degree;</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;        <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;          clusterAod = angle_degree;</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;        <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;          clusterZod = angle_degree;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;          NS_FATAL_ERROR (<span class="stringliteral">&quot;Programming Error&quot;</span>);</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;        }</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    }</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> attenuation_dB;</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a576e8ac3fb04ac54bde5f903058e2295">m_blockage</a>)</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;    {</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;      attenuation_dB = <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac41e36c24b741639642e9bcae35ef9c2">CalAttenuationOfBlockage</a> (params, clusterAoa, clusterZoa);</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;      <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; params-&gt;m_numCluster; cInd++)</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        {</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;          clusterPower.at (cInd) = clusterPower.at (cInd) / pow (10,attenuation_dB.at (cInd) / 10);</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;        }</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    }</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    {</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;      attenuation_dB.push_back (0);</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    }</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;BlockedPower:&quot;;</span></div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterPower.at(i)&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;AOD:&quot;;</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterAod.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;AOA:&quot;;</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterAoa.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;ZOD:&quot;;</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterZod.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="comment">          for (uint8_t d = 0; d &lt; raysPerCluster; d++)</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;<span class="comment">          {</span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;<span class="comment">                  std::cout &lt;&lt;rayZod_radian[i][d]&lt;&lt;&quot;\t&quot;;</span></div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;<span class="comment">          }</span></div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="comment">          std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;</span></div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;ZOA:&quot;;</span></div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; params-&gt;m_numCluster; i++)</span></div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterZoa.at(i)&lt;&lt;&quot;&#39;\t&quot;;</span></div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="comment">//Step 8: Coupling of rays within a cluster for both azimuth and elevation</span></div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;  <span class="comment">//shuffle all the arrays to perform random coupling</span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;  <span class="comment">//since the updating and original generated angles should have the same order of &quot;random coupling&quot;,</span></div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  <span class="comment">//I control the seed of each shuffle, so that the update and original generated angle use the same seed.</span></div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;  <span class="comment">//Is this correct?</span></div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;    {</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      std::shuffle (&amp;rayAod_radian[cIndex][0],&amp;rayAod_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 100));</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;      std::shuffle (&amp;rayAoa_radian[cIndex][0],&amp;rayAoa_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 200));</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;      std::shuffle (&amp;rayZod_radian[cIndex][0],&amp;rayZod_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 300));</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;      std::shuffle (&amp;rayZoa_radian[cIndex][0],&amp;rayZoa_radian[cIndex][raysPerCluster],std::default_random_engine (cIndex * 1000 + 400));</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    }</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;  <span class="comment">//Step 9: Generate the cross polarization power ratios</span></div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  <span class="comment">//This step is skipped, only vertical polarization is considered in this version</span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;  <span class="comment">//Step 10: Draw initial phases</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#ab0854bed411e4946154bde1bc58dfc2e">double2DVector_t</a> clusterPhase = params-&gt;m_clusterPhase;       <span class="comment">//rayAoa_radian[n][m], where n is cluster index, m is ray index</span></div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  <span class="keywordtype">double</span> losPhase = params-&gt;m_losPhase;</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  <span class="comment">// these two should also be generated from previous channel.</span></div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;  <span class="comment">//Step 11: Generate channel coefficients for each cluster n and each receiver and transmitter element pair u,s.</span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af35fc24df93c81f80f9a15773258fc20">complex3DVector_t</a> H_NLOS;       <span class="comment">// channel coefficients H_NLOS [u][s][n],</span></div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  <span class="comment">// where u and s are receive and transmit antenna element, n is cluster index.</span></div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;  uint64_t uSize = rxAntennaNum[0] * rxAntennaNum[1];</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  uint64_t sSize = txAntennaNum[0] * txAntennaNum[1];</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  uint8_t cluster1st = 0, cluster2nd = 0;       <span class="comment">// first and second strongest cluster;</span></div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;  <span class="keywordtype">double</span> maxPower = 0;</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    {</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;      <span class="keywordflow">if</span> (maxPower &lt; clusterPower.at (cIndex))</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        {</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;          maxPower = clusterPower.at (cIndex);</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;          cluster1st = cIndex;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;        }</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    }</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;  maxPower = 0;</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;  <span class="keywordflow">for</span> (uint8_t cIndex = 0; cIndex &lt; params-&gt;m_numCluster; cIndex++)</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;    {</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;      <span class="keywordflow">if</span> (maxPower &lt; clusterPower.at (cIndex) &amp;&amp; cluster1st != cIndex)</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;        {</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;          maxPower = clusterPower.at (cIndex);</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;          cluster2nd = cIndex;</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        }</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;    }</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;1st strongest cluster:&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cluster1st &lt;&lt; <span class="stringliteral">&quot;, 2nd strongest cluster:&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cluster2nd);</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af35fc24df93c81f80f9a15773258fc20">complex3DVector_t</a> H_usn;       <span class="comment">//channel coffecient H_usn[u][s][n];</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;  <span class="comment">//Since each of the strongest 2 clusters are divided into 3 sub-clusters, the total cluster will be numReducedCLuster + 4.</span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;  H_usn.resize (uSize);</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;  <span class="keywordflow">for</span> (uint64_t uIndex = 0; uIndex &lt; uSize; uIndex++)</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    {</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;      H_usn.at (uIndex).resize (sSize);</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;      <span class="keywordflow">for</span> (uint64_t sIndex = 0; sIndex &lt; sSize; sIndex++)</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;        {</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;          H_usn.at (uIndex).at (sIndex).resize (params-&gt;m_numCluster);</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;        }</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    }</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;  <span class="comment">//double slotTime = Simulator::Now ().GetSeconds ();</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;  <span class="comment">// The following for loops computes the channel coefficients</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;  <span class="keywordflow">for</span> (uint64_t uIndex = 0; uIndex &lt; uSize; uIndex++)</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    {</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;      Vector uLoc = rxAntenna-&gt;GetAntennaLocation (uIndex,rxAntennaNum);</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;      <span class="keywordflow">for</span> (uint64_t sIndex = 0; sIndex &lt; sSize; sIndex++)</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        {</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;          Vector sLoc = txAntenna-&gt;GetAntennaLocation (sIndex,txAntennaNum);</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;          <span class="keywordflow">for</span> (uint8_t nIndex = 0; nIndex &lt; params-&gt;m_numCluster; nIndex++)</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;            {</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;              <span class="comment">//Compute the N-2 weakest cluster, only vertical polarization. (7.5-22)</span></div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;              <span class="keywordflow">if</span> (nIndex != cluster1st &amp;&amp; nIndex != cluster2nd)</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                {</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;                  std::complex&lt;double&gt; rays (0,0);</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                  <span class="keywordflow">for</span> (uint8_t mIndex = 0; mIndex &lt; raysPerCluster; mIndex++)</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                    {</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                      <span class="keywordtype">double</span> initialPhase = clusterPhase.at (nIndex).at (mIndex);</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                      <span class="comment">//lambda_0 is accounted in the antenna spacing uLoc and sLoc.</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                      <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rayZoa_radian[nIndex][mIndex]) * cos (rayAoa_radian[nIndex][mIndex]) * uLoc.x</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                                                       + sin (rayZoa_radian[nIndex][mIndex]) * sin (rayAoa_radian[nIndex][mIndex]) * uLoc.y</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;                                                       + cos (rayZoa_radian[nIndex][mIndex]) * uLoc.z);</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;                      <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (rayZod_radian[nIndex][mIndex]) * cos (rayAod_radian[nIndex][mIndex]) * sLoc.x</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                                                       + sin (rayZod_radian[nIndex][mIndex]) * sin (rayAod_radian[nIndex][mIndex]) * sLoc.y</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;                                                       + cos (rayZod_radian[nIndex][mIndex]) * sLoc.z);</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                      <span class="comment">//Doppler is computed in the CalBeamformingGain function and is simplified to only account for the center anngle of each cluster.</span></div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                      <span class="comment">//double doppler = 2*M_PI*(sin(rayZoa_radian[nIndex][mIndex])*cos(rayAoa_radian[nIndex][mIndex])*relativeSpeed.x</span></div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                      <span class="comment">//        + sin(rayZoa_radian[nIndex][mIndex])*sin(rayAoa_radian[nIndex][mIndex])*relativeSpeed.y</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                      <span class="comment">//        + cos(rayZoa_radian[nIndex][mIndex])*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;                      rays += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;                        * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;                           * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;                        * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;                        * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;                      <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;                      <span class="comment">//rays += 1;</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;                    }</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;                  <span class="comment">//rays *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;                  rays *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) = rays;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;                }</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;              <span class="keywordflow">else</span>                   <span class="comment">//(7.5-28)</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;                {</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;                  std::complex&lt;double&gt; raysSub1 (0,0);</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;                  std::complex&lt;double&gt; raysSub2 (0,0);</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;                  std::complex&lt;double&gt; raysSub3 (0,0);</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;                  <span class="keywordflow">for</span> (uint8_t mIndex = 0; mIndex &lt; raysPerCluster; mIndex++)</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;                    {</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;                      <span class="keywordtype">double</span> initialPhase = clusterPhase.at (nIndex).at (mIndex);</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;                      <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rayZoa_radian[nIndex][mIndex]) * cos (rayAoa_radian[nIndex][mIndex]) * uLoc.x</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;                                                       + sin (rayZoa_radian[nIndex][mIndex]) * sin (rayAoa_radian[nIndex][mIndex]) * uLoc.y</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;                                                       + cos (rayZoa_radian[nIndex][mIndex]) * uLoc.z);</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                      <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (rayZod_radian[nIndex][mIndex]) * cos (rayAod_radian[nIndex][mIndex]) * sLoc.x</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                                                       + sin (rayZod_radian[nIndex][mIndex]) * sin (rayAod_radian[nIndex][mIndex]) * sLoc.y</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;                                                       + cos (rayZod_radian[nIndex][mIndex]) * sLoc.z);</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;                      <span class="comment">//double doppler = 2*M_PI*(sin(rayZoa_radian[nIndex][mIndex])*cos(rayAoa_radian[nIndex][mIndex])*relativeSpeed.x</span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                      <span class="comment">//        + sin(rayZoa_radian[nIndex][mIndex])*sin(rayAoa_radian[nIndex][mIndex])*relativeSpeed.y</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;                      <span class="comment">//        + cos(rayZoa_radian[nIndex][mIndex])*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;                      <span class="comment">//double delaySpread;</span></div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;                      <span class="keywordflow">switch</span> (mIndex)</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;                        {</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;                        <span class="keywordflow">case</span> 9:</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;                        <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;                        <span class="keywordflow">case</span> 11:</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;                        <span class="keywordflow">case</span> 12:</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;                        <span class="keywordflow">case</span> 17:</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;                        <span class="keywordflow">case</span> 18:</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;                          <span class="comment">//delaySpread= -2*M_PI*(clusterDelay.at(nIndex)+1.28*c_DS)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;                          raysSub2 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;                          <span class="comment">//raysSub2 +=1;</span></div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;                        <span class="keywordflow">case</span> 13:</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                        <span class="keywordflow">case</span> 14:</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                        <span class="keywordflow">case</span> 15:</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;                        <span class="keywordflow">case</span> 16:</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;                          <span class="comment">//delaySpread = -2*M_PI*(clusterDelay.at(nIndex)+2.56*c_DS)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                          raysSub3 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;                          <span class="comment">//raysSub3 +=1;</span></div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                        <span class="keywordflow">default</span>:                        <span class="comment">//case 1,2,3,4,5,6,7,8,19,20</span></div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;                                                        <span class="comment">//delaySpread = -2*M_PI*clusterDelay.at(nIndex)*m_phyMacConfig-&gt;GetCenterFrequency ();</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                          raysSub1 += exp (std::complex&lt;double&gt; (0, initialPhase))</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;                            * (rxAntenna-&gt;GetRadiationPattern (rayZoa_radian[nIndex][mIndex],rayAoa_radian[nIndex][mIndex])</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;                               * txAntenna-&gt;GetRadiationPattern (rayZod_radian[nIndex][mIndex],rayAod_radian[nIndex][mIndex]))</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;                            * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;                            * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;                          <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;                          <span class="comment">//raysSub1 +=1;</span></div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;                          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;                        }</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;                    }</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;                  <span class="comment">//raysSub1 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;                  <span class="comment">//raysSub2 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;                  <span class="comment">//raysSub3 *= sqrt(clusterPower.at(nIndex))/raysPerCluster;</span></div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;                  raysSub1 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;                  raysSub2 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;                  raysSub3 *= sqrt (clusterPower.at (nIndex) / raysPerCluster);</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) = raysSub1;</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;                  H_usn.at (uIndex).at (sIndex).push_back (raysSub2);</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;                  H_usn.at (uIndex).at (sIndex).push_back (raysSub3);</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                }</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;            }</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;          <span class="keywordflow">if</span> (params-&gt;m_condition == <span class="charliteral">&#39;l&#39;</span>)               <span class="comment">//(7.5-29) &amp;&amp; (7.5-30)</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;            {</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;              std::complex&lt;double&gt; ray (0,0);</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;              <span class="keywordtype">double</span> rxPhaseDiff = 2 * M_PI * (sin (rxAngle.theta) * cos (rxAngle.phi) * uLoc.x</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;                                               + sin (rxAngle.theta) * sin (rxAngle.phi) * uLoc.y</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;                                               + cos (rxAngle.theta) * uLoc.z);</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;              <span class="keywordtype">double</span> txPhaseDiff = 2 * M_PI * (sin (txAngle.theta) * cos (txAngle.phi) * sLoc.x</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;                                               + sin (txAngle.theta) * sin (txAngle.phi) * sLoc.y</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;                                               + cos (txAngle.theta) * sLoc.z);</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;              <span class="comment">//double doppler = 2*M_PI*(sin(rxAngle.theta)*cos(rxAngle.phi)*relativeSpeed.x</span></div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;              <span class="comment">//        + sin(rxAngle.theta)*sin(rxAngle.phi)*relativeSpeed.y</span></div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;              <span class="comment">//        + cos(rxAngle.theta)*relativeSpeed.z)*slotTime*m_phyMacConfig-&gt;GetCenterFrequency ()/3e8;</span></div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;              ray = exp (std::complex&lt;double&gt; (0, losPhase))</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;                * (rxAntenna-&gt;GetRadiationPattern (rxAngle.theta,rxAngle.phi)</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;                   * txAntenna-&gt;GetRadiationPattern (txAngle.theta,txAngle.phi))</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;                * exp (std::complex&lt;double&gt; (0, rxPhaseDiff))</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;                * exp (std::complex&lt;double&gt; (0, txPhaseDiff));</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;              <span class="comment">//*exp(std::complex&lt;double&gt;(0, doppler));</span></div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;              <span class="keywordtype">double</span> K_linear = pow (10,K_factor / 10);</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;              H_usn.at (uIndex).at (sIndex).at (0) = sqrt (1 / (K_linear + 1)) * H_usn.at (uIndex).at (sIndex).at (0) + sqrt (K_linear / (1 + K_linear)) * ray / pow (10,attenuation_dB.at (0) / 10);           <span class="comment">//(7.5-30) for tau = tau1</span></div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;              <span class="keywordtype">double</span> tempSize = H_usn.at (uIndex).at (sIndex).size ();</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;              <span class="keywordflow">for</span> (uint8_t nIndex = 1; nIndex &lt; tempSize; nIndex++)</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;                {</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;                  H_usn.at (uIndex).at (sIndex).at (nIndex) *= sqrt (1 / (K_linear + 1));                   <span class="comment">//(7.5-30) for tau = tau2...taunN</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;                }</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;            }</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;        }</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;    }</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;  <span class="keywordflow">if</span> (cluster1st == cluster2nd)</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    {</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;      clusterDelay.push_back (clusterDelay.at (cluster2nd) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;      clusterDelay.push_back (clusterDelay.at (cluster2nd) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;      clusterAoa.push_back (clusterAoa.at (cluster2nd));</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;      clusterAoa.push_back (clusterAoa.at (cluster2nd));</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;      clusterZoa.push_back (clusterZoa.at (cluster2nd));</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;      clusterZoa.push_back (clusterZoa.at (cluster2nd));</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;    }</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;    {</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;      <span class="keywordtype">double</span> min, max;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;      <span class="keywordflow">if</span> (cluster1st &lt; cluster2nd)</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;        {</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;          min = cluster1st;</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;          max = cluster2nd;</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        }</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;        {</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;          min = cluster2nd;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;          max = cluster1st;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;        }</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;      clusterDelay.push_back (clusterDelay.at (min) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;      clusterDelay.push_back (clusterDelay.at (min) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;      clusterDelay.push_back (clusterDelay.at (max) + 1.28 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;      clusterDelay.push_back (clusterDelay.at (max) + 2.56 * table3gpp-&gt;m_cDS);</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;      clusterAoa.push_back (clusterAoa.at (min));</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;      clusterAoa.push_back (clusterAoa.at (min));</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;      clusterAoa.push_back (clusterAoa.at (max));</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;      clusterAoa.push_back (clusterAoa.at (max));</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;      clusterZoa.push_back (clusterZoa.at (min));</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;      clusterZoa.push_back (clusterZoa.at (min));</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;      clusterZoa.push_back (clusterZoa.at (max));</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;      clusterZoa.push_back (clusterZoa.at (max));</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    }</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;  NS_LOG_INFO (<span class="stringliteral">&quot;size of coefficient matrix =[&quot;</span> &lt;&lt; H_usn.size () &lt;&lt; <span class="stringliteral">&quot;][&quot;</span> &lt;&lt; H_usn.at (0).size () &lt;&lt; <span class="stringliteral">&quot;][&quot;</span> &lt;&lt; H_usn.at (0).at (0).size () &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;  <span class="comment">/*std::cout &lt;&lt; &quot;Delay:&quot;;</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment">  for (uint8_t i = 0; i &lt; clusterDelay.size(); i++)</span></div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="comment">  {</span></div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="comment">          std::cout &lt;&lt;clusterDelay.at(i)&lt;&lt;&quot;s\t&quot;;</span></div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="comment">  }</span></div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="comment">  std::cout &lt;&lt; &quot;\n&quot;;*/</span></div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;  params-&gt;m_delay = clusterDelay;</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;  params-&gt;m_channel = H_usn;</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;  params-&gt;m_angle.clear ();</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;  params-&gt;m_angle.push_back (clusterAoa);</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;  params-&gt;m_angle.push_back (clusterZoa);</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;  params-&gt;m_angle.push_back (clusterAod);</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;  params-&gt;m_angle.push_back (clusterZod);</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;  <span class="comment">//update the previous location.</span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;  <span class="keywordflow">return</span> params;</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;}</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a></div><div class="line"><a name="l02269"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac41e36c24b741639642e9bcae35ef9c2"> 2269</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac41e36c24b741639642e9bcae35ef9c2">MmWaveVehicularSpectrumPropagationLossModel::CalAttenuationOfBlockage</a> (Ptr&lt;Params3gpp&gt; params,</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;                                             <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterAOA, <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> clusterZOA)<span class="keyword"> const</span></div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;  <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> powerAttenuation;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;  uint8_t clusterNum = clusterAOA.size ();</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;  <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; clusterNum; cInd++)</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    {</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;      powerAttenuation.push_back (0);          <span class="comment">//Initial power attenuation for all clusters to be 0 dB;</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    }</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;  <span class="comment">//step a: the number of non-self blocking blockers is stored in m_numNonSelfBloking.</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;  <span class="comment">//step b:Generate the size and location of each blocker</span></div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;  <span class="comment">//generate self blocking (i.e., for blockage from the human body)</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;  <span class="keywordtype">double</span> phi_sb, x_sb, theta_sb, y_sb;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;  <span class="comment">//table 7.6.4.1-1 Self-blocking region parameters.</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#acec66837359b46f1d0c8b28167aa9b45">m_portraitMode</a>)</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;    {</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;      phi_sb = 260;</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;      x_sb = 120;</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;      theta_sb = 100;</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;      y_sb = 80;</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    }</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;  <span class="keywordflow">else</span>      <span class="comment">// landscape mode</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    {</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;      phi_sb = 40;</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;      x_sb = 160;</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      theta_sb = 110;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;      y_sb = 75;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    }</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;  <span class="comment">//generate or update non-self blocking</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;  <span class="keywordflow">if</span> (params-&gt;m_nonSelfBlocking.size () == 0)      <span class="comment">//generate new blocking regions</span></div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;    {</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;      <span class="keywordflow">for</span> (uint16_t blockInd = 0; blockInd &lt; <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a89d7731418073cbb202fa541c4ecec7d">m_numNonSelfBloking</a>; blockInd++)</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;        {</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;          <span class="comment">//draw value from table 7.6.4.1-2 Blocking region parameters</span></div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;          <a class="code" href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">doubleVector_t</a> table;</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;          table.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">m_normalRvBlockage</a>-&gt;GetValue ());              <span class="comment">//phi_k: store the normal RV that will be mapped to uniform (0,360) later.</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;InH-OfficeMixed&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;InH-OfficeOpen&quot;</span>)</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;            {</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;              table.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f090b456c94c6f826df5c39df80ddcc">m_uniformRvBlockage</a>-&gt;GetValue (15, 45));                  <span class="comment">//x_k</span></div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;              table.push_back (90);                   <span class="comment">//Theta_k</span></div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;              table.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f090b456c94c6f826df5c39df80ddcc">m_uniformRvBlockage</a>-&gt;GetValue (5, 15));                  <span class="comment">//y_k</span></div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;              table.push_back (2);                   <span class="comment">//r</span></div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;            }</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;            {</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;              table.push_back (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f090b456c94c6f826df5c39df80ddcc">m_uniformRvBlockage</a>-&gt;GetValue (5, 15));                  <span class="comment">//x_k</span></div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;              table.push_back (90);                   <span class="comment">//Theta_k</span></div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;              table.push_back (5);                   <span class="comment">//y_k</span></div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;              table.push_back (10);                   <span class="comment">//r</span></div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;            }</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;          params-&gt;m_nonSelfBlocking.push_back (table);</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;        }</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    }</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    {</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;      <span class="keywordtype">double</span> deltaX = sqrt (pow (params-&gt;m_preLocUT.x - params-&gt;m_locUT.x, 2) + pow (params-&gt;m_preLocUT.y - params-&gt;m_locUT.y, 2));</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;      <span class="comment">//if deltaX and speed are both 0, the autocorrelation is 1, skip updating</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;      <span class="keywordflow">if</span> (deltaX &gt; 1e-6 || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">m_blockerSpeed</a> &gt; 1e-6)</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;        {</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;          <span class="keywordtype">double</span> corrDis;</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;          <span class="comment">//draw value from table 7.6.4.1-4: Spatial correlation distance for different scenarios.</span></div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;InH-OfficeMixed&quot;</span> || <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">m_scenario</a> == <span class="stringliteral">&quot;InH-OfficeOpen&quot;</span>)</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;            {</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;              <span class="comment">//InH, correlation distance = 5;</span></div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;              corrDis = 5;</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;            }</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;            {</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;              <span class="keywordflow">if</span> (params-&gt;m_o2i)                  <span class="comment">// outdoor to indoor</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;                {</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;                  corrDis = 5;</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;                }</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;              <span class="keywordflow">else</span>                   <span class="comment">//LOS or NLOS</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;                {</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;                  corrDis = 10;</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;                }</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;            }</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;          <span class="keywordtype">double</span> R;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">m_blockerSpeed</a> &gt; 1e-6)               <span class="comment">// speed not equal to 0</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;            {</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;              <span class="keywordtype">double</span> corrT = corrDis / <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">m_blockerSpeed</a>;</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;              R = exp (-1 * (deltaX / corrDis + (Now ().GetSeconds () - params-&gt;m_generatedTime.GetSeconds ()) / corrT));</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;            }</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;            {</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;              R = exp (-1 * (deltaX / corrDis));</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;            }</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;          NS_LOG_INFO (<span class="stringliteral">&quot;Distance change:&quot;</span> &lt;&lt; deltaX &lt;&lt; <span class="stringliteral">&quot; Speed:&quot;</span> &lt;&lt; <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">m_blockerSpeed</a></div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;                                          &lt;&lt; <span class="stringliteral">&quot; Time difference:&quot;</span> &lt;&lt; Now ().GetSeconds () - params-&gt;m_generatedTime.GetSeconds ()</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;                                          &lt;&lt; <span class="stringliteral">&quot; correlation:&quot;</span> &lt;&lt; R);</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;          <span class="comment">//In order to generate correlated uniform random variables, we first generate correlated normal random variables and map the normal RV to uniform RV.</span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;          <span class="comment">//Notice the correlation will change if the RV is transformed from normal to uniform.</span></div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;          <span class="comment">//To compensate the distortion, the correlation of the normal RV is computed</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;          <span class="comment">//such that the uniform RV would have the desired correlation when transformed from normal RV.</span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;          <span class="comment">//The following formula was obtained from MATLAB numerical simulation.</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;          <span class="keywordflow">if</span> (R * R * (-0.069) + R * 1.074 - 0.002 &lt; 1)              <span class="comment">//transform only when the correlation of normal RV is smaller than 1</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;            {</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;              R = R * R * (-0.069) + R * 1.074 - 0.002;</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;            }</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;          <span class="keywordflow">for</span> (uint16_t blockInd = 0; blockInd &lt; <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a89d7731418073cbb202fa541c4ecec7d">m_numNonSelfBloking</a>; blockInd++)</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;            {</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;              <span class="comment">//Generate a new correlated normal RV with the following formula</span></div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;              params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#aac1933f496abe567e4380fc99112f6dc">PHI_INDEX</a>) =</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;                R * params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#aac1933f496abe567e4380fc99112f6dc">PHI_INDEX</a>) + sqrt (1 - R * R) * <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">m_normalRvBlockage</a>-&gt;GetValue ();</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;            }</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        }</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;    }</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;  <span class="comment">//step c: Determine the attenuation of each blocker due to blockers</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;  <span class="keywordflow">for</span> (uint8_t cInd = 0; cInd &lt; clusterNum; cInd++)</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;    {</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;      NS_ASSERT_MSG (clusterAOA.at (cInd) &gt;= 0 &amp;&amp; clusterAOA.at (cInd) &lt;= 360, <span class="stringliteral">&quot;the AOA should be the range of [0,360]&quot;</span>);</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;      NS_ASSERT_MSG (clusterZOA.at (cInd) &gt;= 0 &amp;&amp; clusterZOA.at (cInd) &lt;= 180, <span class="stringliteral">&quot;the ZOA should be the range of [0,180]&quot;</span>);</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;      <span class="comment">//check self blocking</span></div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;      NS_LOG_INFO (<span class="stringliteral">&quot;AOA=&quot;</span> &lt;&lt; clusterAOA.at (cInd) &lt;&lt; <span class="stringliteral">&quot; Block Region[&quot;</span> &lt;&lt; phi_sb - x_sb / 2 &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; phi_sb + x_sb / 2 &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;      NS_LOG_INFO (<span class="stringliteral">&quot;ZOA=&quot;</span> &lt;&lt; clusterZOA.at (cInd) &lt;&lt; <span class="stringliteral">&quot; Block Region[&quot;</span> &lt;&lt; theta_sb - y_sb / 2 &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; theta_sb + y_sb / 2 &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;      <span class="keywordflow">if</span> ( std::abs (clusterAOA.at (cInd) - phi_sb) &lt; (x_sb / 2) &amp;&amp; std::abs (clusterZOA.at (cInd) - theta_sb) &lt; (y_sb / 2))</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        {</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;          powerAttenuation.at (cInd) += 30;               <span class="comment">//anttenuate by 30 dB.</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;          NS_LOG_INFO (<span class="stringliteral">&quot;Cluster[&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cInd &lt;&lt; <span class="stringliteral">&quot;] is blocked by self blocking region and reduce 30 dB power,&quot;</span></div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;                       <span class="stringliteral">&quot;the attenuation is [&quot;</span> &lt;&lt; powerAttenuation.at (cInd) &lt;&lt; <span class="stringliteral">&quot; dB]&quot;</span>);</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        }</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;      <span class="comment">//check non-self blocking</span></div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;      <span class="keywordtype">double</span> phiK, xK, thetaK, yK;</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;      <span class="keywordflow">for</span> (uint16_t blockInd = 0; blockInd &lt; <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a89d7731418073cbb202fa541c4ecec7d">m_numNonSelfBloking</a>; blockInd++)</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;        {</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;          <span class="comment">//The normal RV is transformed to uniform RV with the desired correlation.</span></div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;          phiK = (0.5 * erfc (-1 * params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#aac1933f496abe567e4380fc99112f6dc">PHI_INDEX</a>) / sqrt (2))) * 360;</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;          <span class="keywordflow">while</span> (phiK &gt; 360)</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;            {</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;              phiK -= 360;</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;            }</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;          <span class="keywordflow">while</span> (phiK &lt; 0)</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;            {</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;              phiK += 360;</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;            }</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;          xK = params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a023beaacdde3cbaf70604cf4da305e42">X_INDEX</a>);</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;          thetaK = params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a5d773c28fd925701ed291c2401cddff0">THETA_INDEX</a>);</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;          yK = params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a061187b89198cb94cc331d5a76476bc1">Y_INDEX</a>);</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;          NS_LOG_INFO (<span class="stringliteral">&quot;AOA=&quot;</span> &lt;&lt; clusterAOA.at (cInd) &lt;&lt; <span class="stringliteral">&quot; Block Region[&quot;</span> &lt;&lt; phiK - xK &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; phiK + xK &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;          NS_LOG_INFO (<span class="stringliteral">&quot;ZOA=&quot;</span> &lt;&lt; clusterZOA.at (cInd) &lt;&lt; <span class="stringliteral">&quot; Block Region[&quot;</span> &lt;&lt; thetaK - yK &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; thetaK + yK &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;          <span class="keywordflow">if</span> ( std::abs (clusterAOA.at (cInd) - phiK) &lt; (xK)</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;               &amp;&amp; std::abs (clusterZOA.at (cInd) - thetaK) &lt; (yK))</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;            {</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;              <span class="keywordtype">double</span> A1 = clusterAOA.at (cInd) - (phiK + xK / 2);                   <span class="comment">//(7.6-24)</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;              <span class="keywordtype">double</span> A2 = clusterAOA.at (cInd) - (phiK - xK / 2);                   <span class="comment">//(7.6-25)</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;              <span class="keywordtype">double</span> Z1 = clusterZOA.at (cInd) - (thetaK + yK / 2);                   <span class="comment">//(7.6-26)</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;              <span class="keywordtype">double</span> Z2 = clusterZOA.at (cInd) - (thetaK - yK / 2);                   <span class="comment">//(7.6-27)</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;              <span class="keywordtype">int</span> signA1, signA2, signZ1, signZ2;</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;              <span class="comment">//draw sign for the above parameters according to table 7.6.4.1-3 Description of signs</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;              <span class="keywordflow">if</span> (xK / 2 &lt; clusterAOA.at (cInd) - phiK &amp;&amp; clusterAOA.at (cInd) - phiK &lt;= xK)</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;                {</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;                  signA1 = -1;</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;                }</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;                {</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;                  signA1 = 1;</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;                }</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;              <span class="keywordflow">if</span> (-1 * xK &lt; clusterAOA.at (cInd) - phiK &amp;&amp; clusterAOA.at (cInd) - phiK &lt;= -1 * xK / 2)</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;                {</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                  signA2 = -1;</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;                }</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;                {</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;                  signA2 = 1;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;                }</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;              <span class="keywordflow">if</span> (yK / 2 &lt; clusterZOA.at (cInd) - thetaK &amp;&amp; clusterZOA.at (cInd) - thetaK &lt;= yK)</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;                {</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;                  signZ1 = -1;</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;                }</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;                {</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;                  signZ1 = 1;</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;                }</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;              <span class="keywordflow">if</span> (-1 * yK &lt; clusterZOA.at (cInd) - thetaK &amp;&amp; clusterZOA.at (cInd) - thetaK &lt;= -1 * yK / 2)</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;                {</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;                  signZ2 = -1;</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;                }</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;                {</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;                  signZ2 = 1;</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;                }</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;              <span class="keywordtype">double</span> lambda = 3e8 / <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a>;</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;              <span class="keywordtype">double</span> F_A1 = atan (signA1 * M_PI / 2 * sqrt (M_PI / lambda *</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;                                                            params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a8f6974deb00a9a41c7352e23e76b879a">R_INDEX</a>) * (1 / cos (A1 * M_PI / 180) - 1))) / M_PI; <span class="comment">//(7.6-23)</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;              <span class="keywordtype">double</span> F_A2 = atan (signA2 * M_PI / 2 * sqrt (M_PI / lambda *</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;                                                            params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a8f6974deb00a9a41c7352e23e76b879a">R_INDEX</a>) * (1 / cos (A2 * M_PI / 180) - 1))) / M_PI;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;              <span class="keywordtype">double</span> F_Z1 = atan (signZ1 * M_PI / 2 * sqrt (M_PI / lambda *</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;                                                            params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a8f6974deb00a9a41c7352e23e76b879a">R_INDEX</a>) * (1 / cos (Z1 * M_PI / 180) - 1))) / M_PI;</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;              <span class="keywordtype">double</span> F_Z2 = atan (signZ2 * M_PI / 2 * sqrt (M_PI / lambda *</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;                                                            params-&gt;m_nonSelfBlocking.at (blockInd).at (<a class="code" href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a8f6974deb00a9a41c7352e23e76b879a">R_INDEX</a>) * (1 / cos (Z2 * M_PI / 180) - 1))) / M_PI;</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;              <span class="keywordtype">double</span> L_dB = -20 * log10 (1 - (F_A1 + F_A2) * (F_Z1 + F_Z2));                  <span class="comment">//(7.6-22)</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;              powerAttenuation.at (cInd) += L_dB;</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;              NS_LOG_INFO (<span class="stringliteral">&quot;Cluster[&quot;</span> &lt;&lt; (<span class="keywordtype">int</span>)cInd &lt;&lt; <span class="stringliteral">&quot;] is blocked by no-self blocking, &quot;</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;                           <span class="stringliteral">&quot;the loss is [&quot;</span> &lt;&lt; L_dB &lt;&lt; <span class="stringliteral">&quot;]&quot;</span> &lt;&lt; <span class="stringliteral">&quot; dB&quot;</span>);</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;            }</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;        }</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;    }</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  <span class="keywordflow">return</span> powerAttenuation;</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;}</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;<span class="keywordtype">void</span></div><div class="line"><a name="l02486"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a0f59e8c2b0fa28ae37e2f239b6abaa1b"> 2486</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a0f59e8c2b0fa28ae37e2f239b6abaa1b">MmWaveVehicularSpectrumPropagationLossModel::SetFrequency</a> (<span class="keywordtype">double</span> freq)</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;{</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;  <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a> = freq;</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;}</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l02492"></a><span class="lineno"><a class="line" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad9fb12c1bb96aa3bbd3eb676cdfa855f"> 2492</a></span>&#160;<a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad9fb12c1bb96aa3bbd3eb676cdfa855f">MmWaveVehicularSpectrumPropagationLossModel::GetFrequency</a> (<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">m_frequency</a>;</div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;}</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;} <span class="comment">// namespace millicar</span></div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;} <span class="comment">// namespace ns3</span></div><div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a023beaacdde3cbaf70604cf4da305e42"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a023beaacdde3cbaf70604cf4da305e42">X_INDEX</a></div><div class="ttdeci">#define X_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00048">mmwave-vehicular-spectrum-propagation-loss-model.h:48</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a5d94006c357d5469d5ac24c1796f919a"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5d94006c357d5469d5ac24c1796f919a">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::DeleteChannel</a></div><div class="ttdeci">void DeleteChannel(Ptr&lt; const MobilityModel &gt; a, Ptr&lt; const MobilityModel &gt; b) const</div><div class="ttdoc">Delete the m_channel entry associated to the Params3gpp object of pair (a,b) but keep the other param...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00776">mmwave-vehicular-spectrum-propagation-loss-model.cc:776</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ac41e36c24b741639642e9bcae35ef9c2"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac41e36c24b741639642e9bcae35ef9c2">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::CalAttenuationOfBlockage</a></div><div class="ttdeci">doubleVector_t CalAttenuationOfBlockage(Ptr&lt; Params3gpp &gt; params, doubleVector_t clusterAOA, doubleVector_t clusterZOA) const</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l02269">mmwave-vehicular-spectrum-propagation-loss-model.cc:2269</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_aaddcd856c8a98280eea9b628315a5f87"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaddcd856c8a98280eea9b628315a5f87">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::UpdateChannel</a></div><div class="ttdeci">Ptr&lt; Params3gpp &gt; UpdateChannel(Ptr&lt; Params3gpp &gt; params3gpp, Ptr&lt; ParamsTable &gt; table3gpp, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt; txAntenna, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt; rxAntenna, uint16_t *txAntennaNum, uint16_t *rxAntennaNum, Angles &amp;rxAngle, Angles &amp;txAngle) const</div><div class="ttdoc">Update the channel realization with procedure A of TR 38.900 Sec 7.6.3.2 for the spatial consistency ...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l01632">mmwave-vehicular-spectrum-propagation-loss-model.cc:1632</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a89d7731418073cbb202fa541c4ecec7d"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a89d7731418073cbb202fa541c4ecec7d">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_numNonSelfBloking</a></div><div class="ttdeci">uint16_t m_numNonSelfBloking</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00348">mmwave-vehicular-spectrum-propagation-loss-model.h:348</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ab2c520f59106e0e7a919d6c724a8dd96"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ab2c520f59106e0e7a919d6c724a8dd96">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::AddDevice</a></div><div class="ttdeci">void AddDevice(Ptr&lt; NetDevice &gt;, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt;)</div><div class="ttdoc">Add a device. </div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00171">mmwave-vehicular-spectrum-propagation-loss-model.cc:171</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_af0ca9ddb9e3346bd827d865de86dc5cb"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#af0ca9ddb9e3346bd827d865de86dc5cb">AOD_INDEX</a></div><div class="ttdeci">#define AOD_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00044">mmwave-vehicular-spectrum-propagation-loss-model.h:44</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a6e196f0d24ed2047345eac3b69ce3267"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a6e196f0d24ed2047345eac3b69ce3267">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_scenario</a></div><div class="ttdeci">std::string m_scenario</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00351">mmwave-vehicular-spectrum-propagation-loss-model.h:351</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_a25539d52b47e173ea46e1566f63d2d19"><div class="ttname"><a href="namespacens3_1_1millicar.html#a25539d52b47e173ea46e1566f63d2d19">ns3::millicar::sqrtC_UMi_NLOS</a></div><div class="ttdeci">static const double sqrtC_UMi_NLOS[6][6]</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00066">mmwave-vehicular-spectrum-propagation-loss-model.cc:66</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a19c758f64cd207c57a23640fa13f22b5"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a19c758f64cd207c57a23640fa13f22b5">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_blockerSpeed</a></div><div class="ttdeci">double m_blockerSpeed</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00352">mmwave-vehicular-spectrum-propagation-loss-model.h:352</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_af35fc24df93c81f80f9a15773258fc20"><div class="ttname"><a href="namespacens3_1_1millicar.html#af35fc24df93c81f80f9a15773258fc20">ns3::millicar::complex3DVector_t</a></div><div class="ttdeci">std::vector&lt; complex2DVector_t &gt; complex3DVector_t</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00064">mmwave-vehicular-spectrum-propagation-loss-model.h:64</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_ae854b569d54c7f279a42fae34ad464f9"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#ae854b569d54c7f279a42fae34ad464f9">ZOD_INDEX</a></div><div class="ttdeci">#define ZOD_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00045">mmwave-vehicular-spectrum-propagation-loss-model.h:45</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a917202b8c497ac4275b8c9c75d386caa"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a917202b8c497ac4275b8c9c75d386caa">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_uniformRv</a></div><div class="ttdeci">Ptr&lt; UniformRandomVariable &gt; m_uniformRv</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00336">mmwave-vehicular-spectrum-propagation-loss-model.h:336</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a87bc2bb292dc183649be9046062f3648"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a87bc2bb292dc183649be9046062f3648">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::SetPathlossModel</a></div><div class="ttdeci">void SetPathlossModel(Ptr&lt; PropagationLossModel &gt; pathloss)</div><div class="ttdoc">Set the pathloss model associated to this class. </div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00498">mmwave-vehicular-spectrum-propagation-loss-model.cc:498</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a8f6974deb00a9a41c7352e23e76b879a"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a8f6974deb00a9a41c7352e23e76b879a">R_INDEX</a></div><div class="ttdeci">#define R_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00051">mmwave-vehicular-spectrum-propagation-loss-model.h:51</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a8b0a26806f99d6d9b6aa4d6fd9077f53"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a8b0a26806f99d6d9b6aa4d6fd9077f53">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_frequency</a></div><div class="ttdeci">double m_frequency</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00334">mmwave-vehicular-spectrum-propagation-loss-model.h:334</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a7f1d5772b72f2ce425d85a2b41e8842f"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a7f1d5772b72f2ce425d85a2b41e8842f">AOA_INDEX</a></div><div class="ttdeci">#define AOA_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00042">mmwave-vehicular-spectrum-propagation-loss-model.h:42</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a576e8ac3fb04ac54bde5f903058e2295"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a576e8ac3fb04ac54bde5f903058e2295">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_blockage</a></div><div class="ttdeci">bool m_blockage</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00347">mmwave-vehicular-spectrum-propagation-loss-model.h:347</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_acec66837359b46f1d0c8b28167aa9b45"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#acec66837359b46f1d0c8b28167aa9b45">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_portraitMode</a></div><div class="ttdeci">bool m_portraitMode</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00349">mmwave-vehicular-spectrum-propagation-loss-model.h:349</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a7f0a42713f5a21162341d8e42302ec3f"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f0a42713f5a21162341d8e42302ec3f">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_3gppPathloss</a></div><div class="ttdeci">Ptr&lt; PropagationLossModel &gt; m_3gppPathloss</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00344">mmwave-vehicular-spectrum-propagation-loss-model.h:344</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ac102d1c1876dc3668bbc114a9a4568f8"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac102d1c1876dc3668bbc114a9a4568f8">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_updatePeriod</a></div><div class="ttdeci">Time m_updatePeriod</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00346">mmwave-vehicular-spectrum-propagation-loss-model.h:346</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a5fa94085c9a8f8f8e3c4158c08fd5486"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a5fa94085c9a8f8f8e3c4158c08fd5486">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_oxygenAbsorption</a></div><div class="ttdeci">bool m_oxygenAbsorption</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00350">mmwave-vehicular-spectrum-propagation-loss-model.h:350</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ae0e9dd0e9bf2c545e5673b18275b9321"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ae0e9dd0e9bf2c545e5673b18275b9321">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::GetTypeId</a></div><div class="ttdeci">static TypeId GetTypeId(void)</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00109">mmwave-vehicular-spectrum-propagation-loss-model.cc:109</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a7f090b456c94c6f826df5c39df80ddcc"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a7f090b456c94c6f826df5c39df80ddcc">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_uniformRvBlockage</a></div><div class="ttdeci">Ptr&lt; UniformRandomVariable &gt; m_uniformRvBlockage</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00337">mmwave-vehicular-spectrum-propagation-loss-model.h:337</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ad52c589c90a8cb399316c69f189c054e"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad52c589c90a8cb399316c69f189c054e">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::Get3gppTable</a></div><div class="ttdeci">Ptr&lt; ParamsTable &gt; Get3gppTable(char condition, bool o2i, double hBS, double hUT, double distance2D) const</div><div class="ttdoc">Returns the ParamsTable with the parameters of TR 38.900 Table 7.5-6 that apply to a certain scenario...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00547">mmwave-vehicular-spectrum-propagation-loss-model.cc:547</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_af97429b4a3b1e7bfb77a842ed0f902ac"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#af97429b4a3b1e7bfb77a842ed0f902ac">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_normalRvBlockage</a></div><div class="ttdeci">Ptr&lt; NormalRandomVariable &gt; m_normalRvBlockage</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00340">mmwave-vehicular-spectrum-propagation-loss-model.h:340</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a1a622ae8949ee4a07881d5afc960b4fa"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a1a622ae8949ee4a07881d5afc960b4fa">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::CalLongTerm</a></div><div class="ttdeci">complexVector_t CalLongTerm(Ptr&lt; Params3gpp &gt; params) const</div><div class="ttdoc">Compute and return the long term fading params in order to decrease the computational load  the chann...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00517">mmwave-vehicular-spectrum-propagation-loss-model.cc:517</a></div></div>
<div class="ttc" id="namespacens3_html"><div class="ttname"><a href="namespacens3.html">ns3</a></div><div class="ttdoc">Every class exported by the ns3 library is enclosed in the ns3 namespace. </div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a0f59e8c2b0fa28ae37e2f239b6abaa1b"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a0f59e8c2b0fa28ae37e2f239b6abaa1b">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::SetFrequency</a></div><div class="ttdeci">void SetFrequency(double freq)</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l02486">mmwave-vehicular-spectrum-propagation-loss-model.cc:2486</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a9cb94e871be75a415ffd92015793a535"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a9cb94e871be75a415ffd92015793a535">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::MmWaveVehicularSpectrumPropagationLossModel</a></div><div class="ttdeci">MmWaveVehicularSpectrumPropagationLossModel()</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00095">mmwave-vehicular-spectrum-propagation-loss-model.cc:95</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_ac0dcf0a6942bb2f2d264bce535346f31"><div class="ttname"><a href="namespacens3_1_1millicar.html#ac0dcf0a6942bb2f2d264bce535346f31">ns3::millicar::key_t</a></div><div class="ttdeci">std::pair&lt; Ptr&lt; NetDevice &gt;, Ptr&lt; NetDevice &gt; &gt; key_t</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00066">mmwave-vehicular-spectrum-propagation-loss-model.h:66</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_propagation_loss_model_html"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_propagation_loss_model.html">ns3::millicar::MmWaveVehicularPropagationLossModel</a></div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-propagation-loss-model_8h_source.html#l00057">mmwave-vehicular-propagation-loss-model.h:57</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a31388e68c063456d30daf210783b5f62"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a31388e68c063456d30daf210783b5f62">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::DoDispose</a></div><div class="ttdeci">void DoDispose()</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00165">mmwave-vehicular-spectrum-propagation-loss-model.cc:165</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a369db033235d504e201cb2ab7f509e50"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a369db033235d504e201cb2ab7f509e50">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_expRv</a></div><div class="ttdeci">Ptr&lt; ExponentialRandomVariable &gt; m_expRv</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00342">mmwave-vehicular-spectrum-propagation-loss-model.h:342</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a24261023c0aa41e21d87bb34c86ec085"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a24261023c0aa41e21d87bb34c86ec085">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_deviceAntennaMap</a></div><div class="ttdeci">std::map&lt; Ptr&lt; NetDevice &gt;, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt; &gt; m_deviceAntennaMap</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00356">mmwave-vehicular-spectrum-propagation-loss-model.h:356</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a54e2c1ab8c7d3a47e5e8d4983a8b1faf"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a54e2c1ab8c7d3a47e5e8d4983a8b1faf">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_channelMap</a></div><div class="ttdeci">std::map&lt; key_t, Ptr&lt; Params3gpp &gt; &gt; m_channelMap</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00332">mmwave-vehicular-spectrum-propagation-loss-model.h:332</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_a811ce0ccc8915ec30746ba0ddde6349f"><div class="ttname"><a href="namespacens3_1_1millicar.html#a811ce0ccc8915ec30746ba0ddde6349f">ns3::millicar::oxygen_loss</a></div><div class="ttdeci">static const double oxygen_loss[17][2]</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00075">mmwave-vehicular-spectrum-propagation-loss-model.cc:75</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a5d773c28fd925701ed291c2401cddff0"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a5d773c28fd925701ed291c2401cddff0">THETA_INDEX</a></div><div class="ttdeci">#define THETA_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00049">mmwave-vehicular-spectrum-propagation-loss-model.h:49</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_aac1933f496abe567e4380fc99112f6dc"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#aac1933f496abe567e4380fc99112f6dc">PHI_INDEX</a></div><div class="ttdeci">#define PHI_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00047">mmwave-vehicular-spectrum-propagation-loss-model.h:47</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_a911c55f059ab4c00d336d42eb5e72d62"><div class="ttname"><a href="namespacens3_1_1millicar.html#a911c55f059ab4c00d336d42eb5e72d62">ns3::millicar::offSetAlpha</a></div><div class="ttdeci">static const double offSetAlpha[20]</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00043">mmwave-vehicular-spectrum-propagation-loss-model.cc:43</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a96792d5f699d7d1b86739cdb823c898f"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a96792d5f699d7d1b86739cdb823c898f">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::GetNewChannel</a></div><div class="ttdeci">Ptr&lt; Params3gpp &gt; GetNewChannel(Ptr&lt; ParamsTable &gt; table3gpp, Vector locUT, char condition, bool o2i, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt; txAntenna, Ptr&lt; MmWaveVehicularAntennaArrayModel &gt; rxAntenna, uint16_t *txAntennaNum, uint16_t *rxAntennaNum, Angles &amp;rxAngle, Angles &amp;txAngle, Vector speed, double dis2D, double dis3D) const</div><div class="ttdoc">Get a new realization of the channel  the ParamsTable for the specific scenario  the location of UT  ...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00791">mmwave-vehicular-spectrum-propagation-loss-model.cc:791</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a692e4ac093a0d0b9d0a34c7d62c248b3"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a692e4ac093a0d0b9d0a34c7d62c248b3">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_normalRv</a></div><div class="ttdeci">Ptr&lt; NormalRandomVariable &gt; m_normalRv</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00339">mmwave-vehicular-spectrum-propagation-loss-model.h:339</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html">mmwave-vehicular-spectrum-propagation-loss-model.h</a></div></div>
<div class="ttc" id="namespacemillicar_html"><div class="ttname"><a href="namespacemillicar.html">millicar</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a2acc37751643e20c1f2f34ccd3167c7d"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a2acc37751643e20c1f2f34ccd3167c7d">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::GetOxygenLoss</a></div><div class="ttdeci">double GetOxygenLoss(double frequency, double dist3D, double tau, double tauDelta) const</div><div class="ttdoc">Returns the loss associated to the oxygen absorption as described in p. </div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00474">mmwave-vehicular-spectrum-propagation-loss-model.cc:474</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_add0635c95bb7071713fa1491eb5b6bbf"><div class="ttname"><a href="namespacens3_1_1millicar.html#add0635c95bb7071713fa1491eb5b6bbf">ns3::millicar::complexVector_t</a></div><div class="ttdeci">std::vector&lt; std::complex&lt; double &gt; &gt; complexVector_t</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-antenna-array-model_8h_source.html#l00037">mmwave-vehicular-antenna-array-model.h:37</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_aaa3809b4d4d0731f2206b71a0d5d9d9c"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#aaa3809b4d4d0731f2206b71a0d5d9d9c">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::~MmWaveVehicularSpectrumPropagationLossModel</a></div><div class="ttdeci">virtual ~MmWaveVehicularSpectrumPropagationLossModel()</div><div class="ttdoc">Destructor. </div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00159">mmwave-vehicular-spectrum-propagation-loss-model.cc:159</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a86ab9a21bb66f50f7f4b0c0a0ee1f474"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a86ab9a21bb66f50f7f4b0c0a0ee1f474">ZOA_INDEX</a></div><div class="ttdeci">#define ZOA_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00043">mmwave-vehicular-spectrum-propagation-loss-model.h:43</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_af0398762891de0afcdd4c32592b3c5b9"><div class="ttname"><a href="namespacens3_1_1millicar.html#af0398762891de0afcdd4c32592b3c5b9">ns3::millicar::sqrtC_UMi_LOS</a></div><div class="ttdeci">static const double sqrtC_UMi_LOS[7][7]</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00056">mmwave-vehicular-spectrum-propagation-loss-model.cc:56</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ad9fb12c1bb96aa3bbd3eb676cdfa855f"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad9fb12c1bb96aa3bbd3eb676cdfa855f">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::GetFrequency</a></div><div class="ttdeci">double GetFrequency(void) const</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l02492">mmwave-vehicular-spectrum-propagation-loss-model.cc:2492</a></div></div>
<div class="ttc" id="mmwave-vehicular-spectrum-propagation-loss-model_8h_html_a061187b89198cb94cc331d5a76476bc1"><div class="ttname"><a href="mmwave-vehicular-spectrum-propagation-loss-model_8h.html#a061187b89198cb94cc331d5a76476bc1">Y_INDEX</a></div><div class="ttdeci">#define Y_INDEX</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00050">mmwave-vehicular-spectrum-propagation-loss-model.h:50</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ac2676ed5f8eac0a95bafd6ceb08c57c3"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ac2676ed5f8eac0a95bafd6ceb08c57c3">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::m_o2i</a></div><div class="ttdeci">bool m_o2i</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00354">mmwave-vehicular-spectrum-propagation-loss-model.h:354</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_ab0854bed411e4946154bde1bc58dfc2e"><div class="ttname"><a href="namespacens3_1_1millicar.html#ab0854bed411e4946154bde1bc58dfc2e">ns3::millicar::double2DVector_t</a></div><div class="ttdeci">std::vector&lt; doubleVector_t &gt; double2DVector_t</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00060">mmwave-vehicular-spectrum-propagation-loss-model.h:60</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_a941200314c689b92cec1e37e96b9642e"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#a941200314c689b92cec1e37e96b9642e">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::CalBeamformingGain</a></div><div class="ttdeci">Ptr&lt; SpectrumValue &gt; CalBeamformingGain(Ptr&lt; const SpectrumValue &gt; txPsd, Ptr&lt; Params3gpp &gt; params, complexVector_t longTerm, Vector rxSpeed, Vector txSpeed) const</div><div class="ttdoc">Compute the BF gain, apply frequency selectivity by phase-shifting with the cluster delays and scale ...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00382">mmwave-vehicular-spectrum-propagation-loss-model.cc:382</a></div></div>
<div class="ttc" id="namespacens3_1_1millicar_html_af788bdbc018233ec48d06915e718d522"><div class="ttname"><a href="namespacens3_1_1millicar.html#af788bdbc018233ec48d06915e718d522">ns3::millicar::doubleVector_t</a></div><div class="ttdeci">std::vector&lt; double &gt; doubleVector_t</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8h_source.html#l00059">mmwave-vehicular-spectrum-propagation-loss-model.h:59</a></div></div>
<div class="ttc" id="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model_html_ad4b12bbb003fe17d35474738a4f42d82"><div class="ttname"><a href="classns3_1_1millicar_1_1_mm_wave_vehicular_spectrum_propagation_loss_model.html#ad4b12bbb003fe17d35474738a4f42d82">ns3::millicar::MmWaveVehicularSpectrumPropagationLossModel::DoCalcRxPowerSpectralDensity</a></div><div class="ttdeci">Ptr&lt; SpectrumValue &gt; DoCalcRxPowerSpectralDensity(Ptr&lt; const SpectrumValue &gt; txPsd, Ptr&lt; const MobilityModel &gt; a, Ptr&lt; const MobilityModel &gt; b) const</div><div class="ttdoc">Inherited from SpectrumPropagationLossModel, it returns the PSD at the receiver  the transmitted PSD ...</div><div class="ttdef"><b>Definition:</b> <a href="mmwave-vehicular-spectrum-propagation-loss-model_8cc_source.html#l00178">mmwave-vehicular-spectrum-propagation-loss-model.cc:178</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- ns-3 doxygen header, based on
     HTML header for doxygen 1.8.3.1
     Verified compatible with 1.8.6
-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_3f14f6767c31cb4a1d22c13c18cc6fc3.html">model</a></li><li class="navelem"><a class="el" href="mmwave-vehicular-spectrum-propagation-loss-model_8cc.html">mmwave-vehicular-spectrum-propagation-loss-model.cc</a></li>
    <li class="footer">Generated on Thu Oct 8 2020 15:35:23 for MilliCar by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
